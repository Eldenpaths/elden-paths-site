<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elden Paths™ — Play</title>
  <style>
    body { font-family: monospace; padding: 1em; background: #f9f9f9; }
    #out { white-space: pre-wrap; margin-bottom: 1em; }
    .hidden { display: none; }
    select, input[type="text"], button { margin: 0.5em 0; display: block; }
  </style>
</head>
<body>
  <h1>Elden Paths™ — Play</h1>

  <div id="out">Loading...</div>

  <div id="create" class="hidden">
    <label>Name: <input type="text" id="name" /></label>
    <label>Race:
      <select id="race">
        <option>Human</option>
        <option>Elf</option>
        <option>Dwarf</option>
        <option>Orc</option>
      </select>
    </label>
    <label>Class:
      <select id="class">
        <option>Fighter</option>
        <option>Wizard</option>
        <option>Rogue</option>
        <option>Cleric</option>
      </select>
    </label>

    <label>Roll Mode:
      <select id="mode">
        <option value="auto">Auto Roll</option>
        <option value="manual">Manual Assign</option>
      </select>
    </label>

    <div id="stats" class="hidden">
      <label>STR: <input type="number" id="str" min="1" max="20" value="10" /></label>
      <label>DEX: <input type="number" id="dex" min="1" max="20" value="10" /></label>
      <label>INT: <input type="number" id="int" min="1" max="20" value="10" /></label>
    </div>

    <button onclick="submitCharacter()">Begin Journey</button>
  </div>

  <div id="play" class="hidden">
    <button onclick="move('north')">Go North</button>
    <button onclick="move('south')">Go South</button>
    <button onclick="move('east')">Go East</button>
    <button onclick="move('west')">Go West</button>
  </div>

  <script>
    const api = 'https://player-save.pationandcamp.workers.dev';

    async function loadPlayer() {
      const params = new URLSearchParams(location.search);
      const name = params.get('name');
      if (!name) {
        document.getElementById('create').classList.remove('hidden');
        document.getElementById('out').textContent = 'Enter your character name to begin.';
        return;
      }

      try {
        const res = await fetch(`${api}/loadPlayer?name=${name}`);
        if (!res.ok) throw new Error('New character');
        const data = await res.json();
        render(data);
      } catch (e) {
        document.getElementById('create').classList.remove('hidden');
        document.getElementById('name').value = name;
        document.getElementById('out').textContent = 'Welcome, adventurer. Finish your character:';
      }
    }

    function render(data) {
      document.getElementById('out').textContent = `
Name: ${data.name}
Race: ${data.race}
Class: ${data.class}
Stats: STR ${data.stats.str}, DEX ${data.stats.dex}, INT ${data.stats.int}
Tile: ${data.tile}
Fog: ${data.fog.join(', ')}
XP: ${data.xp}, Level: ${data.level}
Gold: ${data.gold}
Gear: Equipped - ${data.gear.equipped || 'None'}, Inventory - ${data.gear.inventory.join(', ') || 'Empty'}
Conditions: ${data.conditions.join(', ') || 'None'}
Last Seen: ${data.lastSeen}
      `;
      document.getElementById('play').classList.remove('hidden');
    }

    function rollStat() {
      return Math.floor(Math.random() * 8) + 10; // d8+10 for playability
    }

    document.getElementById('mode').addEventListener('change', e => {
      const show = e.target.value === 'manual';
      document.getElementById('stats').classList.toggle('hidden', !show);
    });

    async function submitCharacter() {
      const name = document.getElementById('name').value.trim();
      const race = document.getElementById('race').value;
      const cls = document.getElementById('class').value;
      const mode = document.getElementById('mode').value;

      const stats = {
        str: mode === 'auto' ? rollStat() : parseInt(document.getElementById('str').value),
        dex: mode === 'auto' ? rollStat() : parseInt(document.getElementById('dex').value),
        int: mode === 'auto' ? rollStat() : parseInt(document.getElementById('int').value),
      };

      const payload = {
        name, race, class: cls, stats,
        tile: 'Start', fog: [], xp: 0, level: 1,
        gear: { equipped: null, inventory: [] },
        conditions: [],
        gold: 50,
        lastSeen: new Date().toISOString(),
      };

      await fetch(`${api}/savePlayer`, {
        method: 'POST',
        body: JSON.stringify(payload),
      });

      location.href = `?name=${encodeURIComponent(name)}`;
    }

    async function move(dir) {
      const params = new URLSearchParams(location.search);
      const name = params.get('name');
      const res = await fetch(`${api}/loadPlayer?name=${name}`);
      const player = await res.json();
      player.tile = `Moved-${dir}`;
      player.fog.push(player.tile);
      player.lastSeen = new Date().toISOString();

      await fetch(`${api}/savePlayer`, {
        method: 'POST',
        body: JSON.stringify(player),
      });

      render(player);
    }

    loadPlayer();
  </script>
</body>
</html>
