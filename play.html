<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elden Paths‚Ñ¢ ‚Äî Combat</title>
  <style>
    body { font-family: monospace; padding: 2em; background: #fdfcf8; }
    #out { white-space: pre-wrap; background: #eee; padding: 1em; border-radius: 8px; margin-top: 1em; }
    button { margin: 0.25em; }
  </style>
</head>
<body>
  <h1>Elden Paths‚Ñ¢ ‚Äî Combat Demo</h1>

  <label>Name: <input id="name" /></label>
  <label>Race: 
    <select id="race"><option>Human</option><option>Elf</option><option>Dwarf</option><option>Orc</option></select>
  </label>
  <label>Class: 
    <select id="class"><option>Fighter</option><option>Rogue</option><option>Wizard</option><option>Cleric</option></select>
  </label>
  <button onclick="rollStats()">Roll Stats</button>
  <label>Dice Mode: 
    <select id="diceMode" onchange="saveDiceMode()">
      <option value="auto">Auto Rolls</option>
      <option value="manual">Manual Rolls</option>
    </select>
  </label>
  <br/>
  <button onclick="savePlayer()">Enter World</button>
  <button onclick="loadPlayer()">Load</button>
  <button onclick="fight()">‚öîÔ∏è Fight Goblin</button>
  <div id="out">Ready.</div>
  <button onclick="move('north')">Go North</button>
  <button onclick="move('south')">Go South</button>
  <button onclick="move('east')">Go East</button>
  <button onclick="move('west')">Go West</button>

  <script>
    const WORKER_URL = 'https://player-save.pationandcamp.workers.dev';
    let player = {
      name: '', race: '', class: '',
      stats: {}, tile: 'A1', moves: [],
      xp: 0, level: 1, gold: 50,
      gear: { Equipped: 'None', Inventory: [] },
      hp: 10, conditions: '', lastSeen: ''
    };

    function roll(die) { return Math.floor(Math.random() * die) + 1; }

    function rollStats() {
      const mode = document.getElementById('diceMode').value;
      const doRolls = () => {
        player.stats = {
          STR: roll(6) + 10,
          DEX: roll(6) + 10,
          INT: roll(6) + 10
        };
        updateOutput();
      };
      if (mode === 'manual') {
        if (confirm("Roll STR/DEX/INT?")) doRolls();
      } else {
        doRolls();
      }
    }

    async function fight() {
      const mode = document.getElementById('diceMode').value;
      const goblin = { hp: 5, ac: 12, atkBonus: 2 };
      const pAtkRoll = roll(20);
      const gobAtkRoll = roll(20);

      const pTotal = pAtkRoll + (player.stats.STR || 0);
      const gTotal = gobAtkRoll + goblin.atkBonus;

      let log = `You roll ${pAtkRoll} + STR (${player.stats.STR}) = ${pTotal}\n`;
      if (pTotal >= goblin.ac) {
        const dmg = roll(4);
        goblin.hp -= dmg;
        player.xp += 10;
        log += `‚úÖ Hit! You deal ${dmg} to Goblin (HP now ${goblin.hp}). +10 XP\n`;
      } else {
        log += `‚ùå You missed the Goblin.\n`;
      }

      if (gTotal >= 12) {
        const hit = roll(4);
        player.hp -= hit;
        player.conditions = "Wounded";
        log += `üí• Goblin hits YOU for ${hit}. HP now ${player.hp}\n`;
      } else {
        log += `üõ°Ô∏è Goblin missed you.\n`;
      }

      await savePlayer();
      document.getElementById('out').textContent = log + '\n---\n' + summary();
    }

    function move(dir) {
      player.moves.push('Moved-' + dir);
      player.lastSeen = new Date().toISOString();
      updateOutput();
    }

    function updateOutput() {
      document.getElementById('out').textContent = summary();
    }

    function summary() {
      return `
Name: ${player.name}
Race: ${player.race}
Class: ${player.class}
Stats: STR ${player.stats.STR}, DEX ${player.stats.DEX}, INT ${player.stats.INT}
HP: ${player.hp}
XP: ${player.xp}, Level: ${player.level}
Gold: ${player.gold}
Tile: ${player.tile}
Moves: ${player.moves.join(', ') || 'None'}
Gear: Equipped - ${player.gear.Equipped}, Inventory - ${player.gear.Inventory.join(', ') || 'Empty'}
Conditions: ${player.conditions || 'Healthy'}
Last Seen: ${player.lastSeen}
      `.trim();
    }

    async function savePlayer() {
      player.name = document.getElementById('name').value.trim();
      player.race = document.getElementById('race').value;
      player.class = document.getElementById('class').value;
      player.lastSeen = new Date().toISOString();
      await fetch(`${WORKER_URL}/savePlayer`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(player)
      });
      updateOutput();
    }

    async function loadPlayer() {
      player.name = document.getElementById('name').value.trim();
      if (!player.name) return alert("Enter name.");
      const res = await fetch(`${WORKER_URL}/loadPlayer?name=${player.name}`);
      if (res.ok) {
        player = await res.json();
        updateOutput();
      } else {
        alert("Load failed.");
      }
    }

    function saveDiceMode() {
      localStorage.setItem('diceMode', document.getElementById('diceMode').value);
    }
    function loadDiceMode() {
      const mode = localStorage.getItem('diceMode') || 'auto';
      document.getElementById('diceMode').value = mode;
    }

    loadDiceMode();
  </script>
</body>
</html>
