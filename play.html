<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elden Pathsâ„¢ â€” Phase 25 (NPCs + Dialogue)</title>
  <style>
    body { font-family: monospace; background: #f4f4f4; padding: 2em; }
    #out { white-space: pre-wrap; padding: 1em; background: #eee; border-radius: 6px; margin-bottom: 1em; max-width: 700px; }
    button { margin: 4px; }
    #mapModal {
      display: none;
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      padding: 1em;
      border: 2px solid #333;
      z-index: 1000;
    }
    #mapModal pre { font-size: 16px; line-height: 1.2em; cursor: pointer; }
  </style>
</head>
<body>

<h1>ğŸ“– Elden Pathsâ„¢</h1>
<div id="out">Loading...</div>

<button onclick="move('north')">â¬†ï¸ Go North</button>
<button onclick="move('south')">â¬‡ï¸ Go South</button>
<button onclick="move('east')">â¡ï¸ Go East</button>
<button onclick="move('west')">â¬…ï¸ Go West</button>
<button onclick="descend()">â› Descend</button>
<button onclick="ascend()">ğŸ›— Ascend</button><br>
<button onclick="fight()">âš”ï¸ Fight</button>
<button onclick="rest()">ğŸŒŠ Rest</button>
<button onclick="craft()">ğŸ”§ Craft</button>
<button onclick="shop()">ğŸª Shop</button>
<button onclick="renderMap()">ğŸ—º Show Map</button>
<button onclick="showInventory()">ğŸ’ Inventory</button>

<div id="mapModal">
  <pre id="mapGrid"></pre>
  <button onclick="document.getElementById('mapModal').style.display='none'">Close Map</button>
</div>

<script>
const name = prompt("Enter your name:");
let player = {
  name,
  tile: "0,0",
  z: 0,
  visited: [],
  inventory: [],
  hp: 10,
  maxHp: 10,
  str: 5,
  level: 1,
  xp: 0,
  gear: {},
  gold: 0,
  flags: {},
  timeBelow: 0
};

const tileIcons = {
  "0,0": "ğŸ¡",
  "C4": "ğŸ°",
  "E5": "ğŸ”’"
};

const npcs = {
  "A1,0": () => {
    if (player.flags.bossCleared && !player.flags.mayorReward) {
      player.flags.mayorReward = true;
      player.gold += 10;
      alert("ğŸ§“ Mayor: Brave soul! The beast is gone? Here, take this â€” 10 gold.");
    } else if (player.flags.bossCleared) {
      alert("ğŸ§“ Mayor: Youâ€™ve already proven yourself.");
    } else {
      alert("ğŸ§“ Mayor: We fear the creature in the ruins...");
    }
  },
  "D5,0": () => {
    if (!player.flags.bossCleared) {
      alert("ğŸ¤• Wounded Knight: Beware... the beast still lives...");
    } else {
      alert("ğŸ¤• Wounded Knight: You did it... we are avenged.");
    }
  }
};

function tileKey(x, y, z) {
  return `${x},${y},${z}`;
}

function markVisited() {
  const key = tileKey(...player.tile.split(',').map(Number), player.z);
  if (!player.visited.includes(key)) player.visited.push(key);
}

function renderMap() {
  const [px, py] = player.tile.split(',').map(Number);
  const z = player.z;
  const label = z === 0 ? 'Surface' : (z < 0 ? 'Underground' : `Z=${z}`);
  let output = `ğŸ—º Map View â€” ${label} (5x5):\n\n`;
  for (let y = py + 2; y >= py - 2; y--) {
    for (let x = px - 2; x <= px + 2; x++) {
      const key = tileKey(x, y, z);
      let char = ".";
      if (player.tile === `${x},${y}`) char = "@";
      else if (player.visited.includes(key)) char = tileIcons[`${x},${y}`] || "#";
      output += `<span onclick=\"travelTo('${x},${y}', ${z})\">${char}</span> `;
    }
    output += "\n";
  }
  document.getElementById("mapGrid").innerHTML = output;
  document.getElementById("mapModal").style.display = "block";
}

function travelTo(coord, zTarget) {
  if (zTarget !== player.z) return alert("â›” Can't travel between layers.");
  const key = tileKey(...coord.split(',').map(Number), zTarget);
  if (!player.visited.includes(key)) return alert("âŒ Fogged tile.");
  player.tile = coord;
  markVisited();
  update(`ğŸ§­ Traveled to ${coord}`);
  document.getElementById("mapModal").style.display = "none";
}

function update(log = "") {
  const status =
    `ğŸ§ ${player.name} | â¤ï¸ ${player.hp}/${player.maxHp} | âš”ï¸ ${player.str} | ğŸŒŸ Level ${player.level}\n` +
    `ğŸ“ Tile: ${player.tile}, z=${player.z} | ğŸ’° ${player.gold}g\n` +
    `ğŸ’ ${player.inventory.join(', ') || 'Empty'}`;
  if (player.z < 0) {
    player.timeBelow++;
    if (player.timeBelow > 5 && !player.flags.deepWarning) {
      player.flags.deepWarning = true;
      log += "\nâ˜ï¸ You feel the weight of the stone above...";
    }
  } else {
    player.timeBelow = 0;
  }
  document.getElementById("out").textContent = `${log}\n\n${status}`;
}

function move(dir) {
  let [x, y] = player.tile.split(',').map(Number);
  if (dir === 'north') y++;
  if (dir === 'south') y--;
  if (dir === 'east') x++;
  if (dir === 'west') x--;
  player.tile = `${x},${y}`;
  markVisited();
  let log = `ğŸš¶ Moved ${dir.toUpperCase()} to ${player.tile}`;
  checkTriggers(log);
}

function descend() {
  if (player.z === 0 && player.tile === "C4") {
    player.z = -1;
    markVisited();
    update("â› You descend into the catacombs...");
  } else {
    alert("âŒ No descent here.");
  }
}

function ascend() {
  if (player.z < 0) {
    player.z = 0;
    markVisited();
    update("ğŸ›— You climb back to the surface.");
  } else {
    alert("âš ï¸ You're already on the surface.");
  }
}

function checkTriggers(log) {
  const key = `${player.tile},${player.z}`;
  if (npcs[key]) npcs[key]();

  if (player.tile === "D5" && !player.flags.bossCleared) {
    player.flags.bossCleared = true;
    player.xp += 20;
    log += "\nğŸ’€ Dungeon beast defeated! +20 XP.";
  }
  if (player.tile === "A1" && player.flags.bossCleared && !player.flags.townEvent) {
    player.flags.townEvent = true;
    log += "\nğŸ‰ Town celebrates your return!";
  }
  update(log);
}

function rest() {
  const healed = Math.min(player.maxHp - player.hp, 4);
  player.hp += healed;
  update(`ğŸ›Œ Rested +${healed} HP.`);
}

function fight() {
  const mob = { hp: 6, str: 3 };
  let log = "âš”ï¸ Battle begins!\n";
  while (mob.hp > 0 && player.hp > 0) {
    mob.hp -= player.str;
    if (mob.hp <= 0) break;
    player.hp -= mob.str;
  }
  if (player.hp <= 0) log += "â˜ ï¸ You were defeated!";
  else {
    player.xp += 10;
    player.gold += 3;
    player.inventory.push("Herb");
    log += "âœ… Victory! +10 XP, +3g, Herb found.";
  }
  update(log);
}

function showInventory() {
  alert("ğŸ’ " + (player.inventory.join(', ') || 'Empty'));
}

function craft() {
  const i = player.inventory;
  if (i.filter(x => x === "Herb").length >= 2) {
    i.splice(i.indexOf("Herb"), 1);
    i.splice(i.indexOf("Herb"), 1);
    i.push("Healing Brew");
    alert("ğŸ§ª Crafted Healing Brew.");
  } else {
    alert("âŒ Not enough materials.");
  }
  update("ğŸ§ª Crafting complete.");
}

function shop() {
  const buy = prompt("Shop:\n1. Herb (3g)\n2. Shield (+1 max HP, 5g)");
  if (buy === "1" && player.gold >= 3) {
    player.gold -= 3;
    player.inventory.push("Herb");
    update("ğŸ› Bought Herb.");
  } else if (buy === "2" && player.gold >= 5) {
    player.gold -= 5;
    player.maxHp += 1;
    update("ğŸ›¡ Bought and equipped Shield. Max HP +1");
  } else {
    alert("âŒ Can't afford that.");
  }
}

markVisited();
update("ğŸŒŸ Welcome to Elden Paths (Phase 25)");
</script>

</body>
</html>
