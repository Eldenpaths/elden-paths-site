
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Elden Paths™ — Core World Engine</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="sketch_map.js"></script>
  <style>
    body {
      font-family: 'Garamond', serif;
      background-image: url('assets/img/parchment-bg.jpg');
      background-size: cover;
      margin: 0;
      padding: 0;
      color: #3e2d1c;
    }
    .container {
      display: none;
      grid-template-columns: 1fr 2fr 1fr;
      grid-template-rows: auto 1fr auto;
      grid-template-areas:
        "header header header"
        "stats map sketch"
        "console console sketch";
      height: 100vh;
    }
    header {
      grid-area: header;
      text-align: center;
      padding: 1em;
    }
    .map {
      grid-area: map;
      padding: 20px;
    }
    .console {
      grid-area: console;
      padding: 20px;
      background: rgba(255,248,220,0.95);
      border-top: 2px solid #8b5a2b;
    }
    .console input[type="text"] {
      width: 60%;
      padding: 10px;
      margin-right: 10px;
      border-radius: 6px;
      border: 1px solid #5c4323;
    }
    .console button {
      padding: 10px 16px;
      background-color: #e6d1a4;
      border: 1px solid #5c4323;
      border-radius: 6px;
      cursor: pointer;
      margin: 4px;
    }
    .sketch {
      grid-area: sketch;
      padding: 20px;
      background: rgba(255, 255, 255, 0.85);
      border-left: 2px solid #8b5a2b;
    }
    .sketch img {
      width: 100%;
      margin-bottom: 10px;
      border: 1px solid #3e2d1c;
    }
    .stats {
      grid-area: stats;
      padding: 20px;
      background: rgba(255, 255, 240, 0.9);
      border-right: 2px solid #8b5a2b;
    }
    .login {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: rgba(255, 248, 220, 0.9);
    }
    .login input {
      padding: 10px;
      font-size: 1.1em;
      margin-bottom: 10px;
    }
    .login button {
      padding: 10px 20px;
      font-size: 1.1em;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="login" id="loginScreen">
    <h1>Elden Paths™</h1>
    <p>Enter your character name:</p>
    <input id="nameInput" type="text" placeholder="roslin, ringo..." />
    <button onclick="enterGame()">Enter World</button>
  </div>

  <div class="container" id="gameUI">
    <header>
      <img src="assets/img/logo.png" alt="Elden Paths Logo" style="height:80px;">
      <h1>Elden Paths™</h1>
      <p><em>Core World Engine: Explore, build, battle, remember.</em></p>
    </header>
    <div class="stats" id="statsBox">Loading stats...</div>
    <div class="map">
      <h2>Current Region</h2>
      <p id="log">Loading...</p>
    </div>
    <div class="console">
      <input type="text" id="command" placeholder="go north / build camp / attack / note ..." onkeydown="if(event.key==='Enter') handleCommand()" />
      <button onclick="handleCommand()">Send</button>
    </div>
    <div class="sketch">
      <h2>Sketch</h2>
      <img id="sketch-img" src="assets/sketches/sample.png" alt="Sketch View" />
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAiZZyiy8Y38uJU1z1lVGnXU14vqKxbg6s",
      authDomain: "elden-paths.firebaseapp.com",
      databaseURL: "https://elden-paths-default-rtdb.firebaseio.com",
      projectId: "elden-paths",
      storageBucket: "elden-paths.appspot.com",
      messagingSenderId: "514433622971",
      appId: "1:514433622971:web:b9103716c78acf6c7c01a9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let playerName = "", playerData = {}, tileIndex = {}, playerTileId = "";

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      speechSynthesis.speak(utterance);
    }

    async function enterGame() {
      playerName = document.getElementById("nameInput").value.trim().toLowerCase();
      if (!playerName) return alert("Enter a name.");
      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("gameUI").style.display = "grid";

      const [tileSnap, playerSnap] = await Promise.all([
        db.ref("tile_index").get(),
        db.ref("players/" + playerName).get()
      ]);

      tileIndex = tileSnap.val() || {};
      playerData = playerSnap.val() || {
        tile: "tile_130_90",
        inventory: ["cloak", "flint"],
        hp: 10,
        stamina: 10,
        discovered: ["tile_130_90"],
        trail: []
      };

      playerTileId = playerData.tile;
      updateDisplay(playerTileId);
      updateStats();
    }

    function updateStats() {
      const gearList = (playerData.inventory || []).map(i => `<li>• ${i}</li>`).join("");
      document.getElementById("statsBox").innerHTML = `
        <h2>${playerName}</h2>
        <p><strong>HP:</strong> ${playerData.hp}</p>
        <p><strong>Stamina:</strong> ${playerData.stamina}</p>
        <h3>Inventory</h3>
        <ul>${gearList}</ul>
      `;
    }

    async function updateDisplay(tileId) {
      const tile = tileIndex[tileId] || { name: "Unknown", terrain: "unknown", travel_minutes: "?" };
      const sketchPath = sketchArtByTerrain[tile.terrain] || "assets/sketches/sample.png";
      const structure = tile.structure ? `<br><strong>Structure:</strong> ${tile.structure.type} (by ${tile.structure.owner})` : "";
      const notes = tile.notes && tile.notes[playerName] ? `<br><em>Your note:</em> "${tile.notes[playerName]}"` : "";
      document.getElementById("log").innerHTML = `
        <strong>${tile.name}</strong><br>
        Terrain: ${tile.terrain}<br>
        Travel Time: ${tile.travel_minutes} minutes${structure}${notes}
      `;
      document.getElementById("sketch-img").src = sketchPath;

      // Apply effects
      if (tile.structure && tile.structure.type === "camp") playerData.hp = Math.min(playerData.hp + 2, 10);
      if (tile.structure && tile.structure.type === "shrine") playerData.stamina = Math.min(playerData.stamina + 1, 10);

      await db.ref("players/" + playerName).set(playerData);
      speak(`You have entered ${tile.name}, a ${tile.terrain} terrain.`);
    }

    async function handleCommand() {
      const input = document.getElementById("command").value.trim().toLowerCase();
      document.getElementById("command").value = "";

      if (!input) return;
      if (input.startsWith("go ")) {
        const dir = input.split(" ")[1];
        let [_, xStr, yStr] = playerTileId.split("_");
        let x = parseInt(xStr), y = parseInt(yStr);
        if (dir === "north") y--;
        else if (dir === "south") y++;
        else if (dir === "east") x++;
        else if (dir === "west") x--;
        else return speak("Invalid direction.");
        const nextTileId = `tile_${x}_${y}`;
        if (!tileIndex[nextTileId]) return speak("You can't go that way.");
        playerTileId = nextTileId;
        playerData.tile = nextTileId;
        if (!playerData.discovered.includes(nextTileId)) playerData.discovered.push(nextTileId);
        if (!playerData.trail.includes(nextTileId)) playerData.trail.push(nextTileId);
        await db.ref("players/" + playerName).set(playerData);
        updateDisplay(nextTileId);
        updateStats();
        return;
      }

      if (input.startsWith("build ")) {
        const type = input.split(" ")[1];
        const structure = { type, owner: playerName, built_at: new Date().toISOString() };
        await db.ref("tile_index/" + playerTileId + "/structure").set(structure);
        tileIndex[playerTileId].structure = structure;
        speak(`You built a ${type}.`);
        updateDisplay(playerTileId);
        return;
      }

      if (input.startsWith("note ")) {
        const message = input.slice(5).trim();
        await db.ref(`tile_index/${playerTileId}/notes/${playerName}`).set(message);
        speak("Note saved.");
        updateDisplay(playerTileId);
        return;
      }

      if (input === "attack") {
        const roll = Math.floor(Math.random() * 20) + 1 + 2;
        const result = roll >= 12 ? "You hit the creature!" : "You missed!";
        if (roll < 12) playerData.hp -= 2;
        speak(`${result}`);
        updateStats();
        await db.ref("players/" + playerName).set(playerData);
        return;
      }

      if (input.startsWith("loot ")) {
        const item = input.split(" ")[1];
        if (!playerData.inventory.includes(item)) playerData.inventory.push(item);
        speak(`You looted a ${item}.`);
        updateStats();
        await db.ref("players/" + playerName).set(playerData);
        return;
      }

      speak("Unknown command.");
    }
  </script>
</body>
</html>
