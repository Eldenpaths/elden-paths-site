<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Elden Paths – Play</title>
  <style>
    body { background: #111; color: #eee; font-family: sans-serif; padding: 2em; text-align: center; }
    #sketch, #encounter { margin-top: 1em; max-width: 90%; border: 2px solid #444; display: none; }
    #message, #combat { margin-top: 1em; }
    button { margin: 0.5em; padding: 0.5em 1em; font-size: 1em; }
  </style>
</head>
<body>
  <h1>Elden Paths – Play</h1>
  <div id="status">Loading player data...</div>
  <div id="message"></div>
  <img id="sketch" />
  <img id="encounter" />
  <div id="combat"></div>

  <script>
    const playerName = "example_player";
    let playerData, tileMarkers, encounters;

    async function fetchJSON(path) {
      const res = await fetch(path);
      return await res.json();
    }

    function chance(prob) {
      return Math.random() < prob;
    }

    function rollDice(die) {
      const sides = parseInt(die.substring(1));
      return Math.floor(Math.random() * sides) + 1;
    }

    async function loadGame() {
      const players = await fetchJSON("data/players.json");
      const tileIndex = await fetchJSON("data/tile_index.json");
      tileMarkers = await fetchJSON("data/tile_markers.json");
      encounters = await fetchJSON("data/encounters.json");

      playerData = players[playerName];
      const tile = playerData.tile;
      const fogged = !tileIndex[tile]?.fog_cleared;
      document.getElementById("status").textContent = `You are at tile ${tile} (${fogged ? "shrouded in fog" : "visible"}).`;

      const sketchImg = document.getElementById("sketch");
      const encounterImg = document.getElementById("encounter");
      const messageDiv = document.getElementById("message");
      const combatDiv = document.getElementById("combat");

      if (tileMarkers[tile]) {
        const triggered = tileMarkers[tile].some(marker => marker.sketch_trigger);
        if (triggered) {
          sketchImg.src = `sketches/${tile}.png`;
          sketchImg.alt = `Sketch for tile ${tile}`;
          sketchImg.style.display = "block";
        }

        for (let marker of tileMarkers[tile]) {
          if (marker.encounter_chance && chance(marker.encounter_chance)) {
            const enc = encounters[marker.encounter_type];
            if (enc) {
              messageDiv.textContent = enc.description;
              if (enc.sketch) {
                encounterImg.src = `sketches/${enc.sketch}`;
                encounterImg.alt = enc.description;
                encounterImg.style.display = "block";
              }

              // Combat preview
              const enemy = enc.enemy;
              if (enemy) {
                combatDiv.innerHTML = `
                  <p><strong>Enemy:</strong> ${enemy.name} (HP: ${enemy.hp}, Attack: ${enemy.attack_die})</p>
                  <p><strong>Your HP:</strong> ${playerData.hp} | <strong>Your Weapon:</strong> Rusty Sword (d6)</p>
                  <button onclick="fight('${enemy.name}', ${enemy.hp}, '${enemy.attack_die}')">Fight</button>
                  <button onclick="flee()">Flee</button>
                `;
              }
              break;
            }
          }
        }
      }
    }

    function fight(enemyName, enemyHP, enemyDie) {
      const playerRoll = rollDice("d6");
      const enemyRoll = rollDice(enemyDie);
      const outcome = document.getElementById("combat");
      outcome.innerHTML = `
        <p>You swing your sword for <strong>${playerRoll}</strong> damage.</p>
        <p>${enemyName} strikes back for <strong>${enemyRoll}</strong> damage.</p>
        <p><em>(No actual damage recorded – prototype only)</em></p>
      `;
    }

    function flee() {
      document.getElementById("combat").innerHTML = "<p>You retreat quietly into the woods...</p>";
    }

    loadGame();
  </script>
</body>
</html>
