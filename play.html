<!DOCTYPE html>
<html>
<head>
  <title>Elden Paths™ — Play</title>
  <meta charset="UTF-8">
</head>
<body>
  <h1>Elden Paths™ — Play</h1>

  <div id="characterDisplay"></div>

  <button onclick="move('north')">Go North</button>
  <button onclick="move('south')">Go South</button>
  <button onclick="move('east')">Go East</button>
  <button onclick="move('west')">Go West</button>
  <br><br>

  <button onclick="fight()">Fight Nearby Threat</button>
  <br><br>

  <button onclick="saveCharacter()">Save Character</button>

  <script>
    let character = {
      name: "the dood",
      race: "human",
      class: "fighter",
      stats: { STR: 14, DEX: 12, INT: 11 },
      tile: "A1",
      fog: ["A1"],
      xp: 0,
      level: 1,
      hp: 20,
      ac: 12,
      gear: {
        equipped: ["Starter Sword"],
        inventory: ["Bread", "Torch"]
      },
      conditions: [],
      lastSeen: new Date().toISOString()
    };

    function displayCharacter() {
      const c = character;
      document.getElementById("characterDisplay").innerHTML = `
        <p><strong>Name:</strong> ${c.name}<br>
        <strong>Race:</strong> ${c.race} | <strong>Class:</strong> ${c.class}<br>
        <strong>Stats:</strong> STR ${c.stats.STR}, DEX ${c.stats.DEX}, INT ${c.stats.INT}<br>
        <strong>HP:</strong> ${c.hp} | <strong>AC:</strong> ${c.ac} | <strong>XP:</strong> ${c.xp} | <strong>Level:</strong> ${c.level}<br>
        <strong>Tile:</strong> ${c.tile}<br>
        <strong>Gear:</strong> Equipped - ${c.gear.equipped.join(", ")}, Inventory - ${c.gear.inventory.join(", ")}<br>
        <strong>Conditions:</strong> ${c.conditions.length ? c.conditions.join(", ") : "None"}<br>
        <strong>Last Seen:</strong> ${c.lastSeen}</p>
      `;
    }

    function move(direction) {
      character.tile = "Moved " + direction;
      character.lastSeen = new Date().toISOString();
      displayCharacter();
    }

    function saveCharacter() {
      fetch('/api/saveCharacter', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(character)
      }).then(res => {
        if (res.ok) alert("Character saved!");
        else alert("Save failed.");
      });
    }

    async function autoLoadCharacter() {
      const res = await fetch(`/api/loadCharacter?name=${encodeURIComponent(character.name)}`);
      if (res.ok) {
        const saved = await res.json();
        if (saved) {
          character = saved;
          console.log("Character loaded.");
        }
      }
      displayCharacter();
    }

    function rollDie(sides) {
      return Math.floor(Math.random() * sides) + 1;
    }

    function getAttackBonus(c) {
      return Math.floor(c.stats.STR / 2) + c.level;
    }

    function getDamageBonus(c) {
      return Math.floor(c.stats.STR / 3);
    }

    function buildEnemy(name) {
      const templates = {
        "Goblin": { name: "Goblin", hp: 12, ac: 11, attack: () => rollDie(4) + 1, xp: 5 },
        "Wolf": { name: "Wolf", hp: 10, ac: 13, attack: () => rollDie(6), xp: 6 },
        "Shade": { name: "Shade", hp: 14, ac: 12, attack: () => rollDie(6) + 2, xp: 8 },
        "Skeleton": { name: "Skeleton", hp: 15, ac: 10, attack: () => rollDie(6), xp: 7 },
        "Reef Drake": { name: "Reef Drake", hp: 22, ac: 14, attack: () => rollDie(8), xp: 10 },
        "Pirate Raider": { name: "Pirate Raider", hp: 16, ac: 12, attack: () => rollDie(6) + 1, xp: 9 }
      };
      return templates[name] || templates["Goblin"];
    }

    async function fight() {
      const tile = character.tile;
      const res = await fetch('/tile_meta.json');
      const meta = await res.json();
      const tileData = meta[tile] || {};
      const enemyName = (tileData.enemies || ["Goblin"])[Math.floor(Math.random() * (tileData.enemies?.length || 1))];
      const enemy = buildEnemy(enemyName);

      const roll = rollDie(20);
      const hit = roll + getAttackBonus(character) >= enemy.ac;
      let outcome;

      if (hit) {
        const dmg = rollDie(enemy.hp > 15 ? 8 : 6) + getDamageBonus(character);
        enemy.hp -= dmg;
        outcome = `You hit the ${enemy.name} for ${dmg} damage!`;

        if (enemy.hp <= 0) {
          outcome += ` The ${enemy.name} falls!`;
          character.xp += enemy.xp || 5;
          sketchBattle("combat_win", character, enemy);
        }
      } else {
        outcome = `You miss the ${enemy.name}. It counters!`;
        const injury = enemy.attack();
        character.hp -= injury;
        outcome += ` You take ${injury} damage.`;

        if (character.hp <= 0) {
          character.conditions.push("Wounded");
          outcome += " You are badly wounded!";
          sketchBattle("combat_wound", character, enemy);
        }
      }

      alert(outcome);
      displayCharacter();
      saveCharacter();
    }

    function sketchBattle(tag, player, enemy) {
      // Placeholder: hook into sketch engine
      console.log(`[SKETCH] ${tag} scene triggered: ${player.name} vs ${enemy.name}`);
    }

    autoLoadCharacter();
  </script>
</body>
</html>
