<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elden Paths™ — Phase 23 (Triggers + Underground)</title>
  <style>
    body { font-family: monospace; background: #f4f4f4; padding: 2em; }
    #out { white-space: pre-wrap; padding: 1em; background: #eee; border-radius: 6px; margin-bottom: 1em; max-width: 700px; }
    button { margin: 4px; }
    #mapModal {
      display: none;
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      padding: 1em;
      border: 2px solid #333;
      z-index: 1000;
    }
    #mapModal pre { font-size: 16px; line-height: 1.2em; cursor: pointer; }
  </style>
</head>
<body>

<h1>📖 Elden Paths™</h1>
<div id="out">Loading...</div>

<button onclick="move('north')">⬆️ Go North</button>
<button onclick="move('south')">⬇️ Go South</button>
<button onclick="move('east')">➡️ Go East</button>
<button onclick="move('west')">⬅️ Go West</button>
<button onclick="descend()">⛏ Descend</button><br>
<button onclick="fight()">⚔️ Fight</button>
<button onclick="rest()">🌊 Rest</button>
<button onclick="craft()">🔧 Craft</button>
<button onclick="shop()">🏪 Shop</button>
<button onclick="renderMap()">🗺 Show Map</button>
<button onclick="showInventory()">🎒 Inventory</button>

<div id="mapModal">
  <pre id="mapGrid"></pre>
  <button onclick="document.getElementById('mapModal').style.display='none'">Close Map</button>
</div>

<script>
const name = prompt("Enter your name:");
let player = {
  name,
  tile: "0,0",
  z: 0,
  visited: [],
  inventory: [],
  hp: 10,
  maxHp: 10,
  str: 5,
  level: 1,
  xp: 0,
  gear: {},
  gold: 0,
  flags: {}
};

const tileIcons = {
  "0,0": "🏡",
  "C4": "🏰",
  "E5": "🔒"
};

function tileKey(x, y, z) {
  return `${x},${y},${z}`;
}

function markVisited() {
  const key = tileKey(...player.tile.split(',').map(Number), player.z);
  if (!player.visited.includes(key)) player.visited.push(key);
}

function renderMap() {
  const [px, py] = player.tile.split(',').map(Number);
  const z = player.z;
  let output = `🗺 Layer ${z === 0 ? 'Surface' : 'Underground'} (5x5):\n\n`;
  for (let y = py + 2; y >= py - 2; y--) {
    for (let x = px - 2; x <= px + 2; x++) {
      const key = tileKey(x, y, z);
      let char = ".";
      if (player.tile === `${x},${y}` && z === player.z) char = "@";
      else if (player.visited.includes(key)) char = tileIcons[`${x},${y}`] || "#";
      output += `<span onclick=\"travelTo('${x},${y}')\">${char}</span> `;
    }
    output += "\n";
  }
  document.getElementById("mapGrid").innerHTML = output;
  document.getElementById("mapModal").style.display = "block";
}

function travelTo(coord) {
  const key = tileKey(...coord.split(',').map(Number), player.z);
  if (!player.visited.includes(key)) return alert("❌ Can't travel to fogged tile.");
  player.tile = coord;
  markVisited();
  update(`🧭 Traveled to ${coord} at z=${player.z}`);
  document.getElementById("mapModal").style.display = "none";
}

function update(log = "") {
  const status =
    `🧝 ${player.name} | ❤️ ${player.hp}/${player.maxHp} | ⚔️ ${player.str} STR | 🌟 Level ${player.level}\n` +
    `📍 Tile: ${player.tile}, z=${player.z} | 💰 ${player.gold}g\n` +
    `🎒 ${player.inventory.join(', ') || 'Empty'}`;
  document.getElementById("out").textContent = `${log}\n\n${status}`;
}

function move(dir) {
  let [x, y] = player.tile.split(',').map(Number);
  if (dir === 'north') y++;
  if (dir === 'south') y--;
  if (dir === 'east') x++;
  if (dir === 'west') x--;
  player.tile = `${x},${y}`;
  markVisited();
  let log = `🚶 Moved ${dir.toUpperCase()} to ${player.tile}`;
  checkTriggers(log);
}

function descend() {
  if (player.z === 0 && player.tile === "C4") {
    player.z = -1;
    markVisited();
    update("⛏ You descend into the catacombs...");
  } else {
    alert("❌ No descent possible here.");
  }
}

function checkTriggers(log) {
  if (player.tile === "D5" && !player.flags.bossCleared) {
    player.flags.bossCleared = true;
    player.xp += 20;
    log += "\n💀 You defeat the dungeon beast! +20 XP.";
  }
  if (player.tile === "A1" && player.flags.bossCleared && !player.flags.townEvent) {
    player.flags.townEvent = true;
    log += "\n🎉 The townsfolk celebrate your victory!";
  }
  update(log);
}

function rest() {
  const healed = Math.min(player.maxHp - player.hp, 4);
  player.hp += healed;
  update(`🛌 Rested +${healed} HP.`);
}

function fight() {
  const mob = { hp: 6, str: 3 };
  let log = "⚔️ Battle begins!\n";
  while (mob.hp > 0 && player.hp > 0) {
    mob.hp -= player.str;
    if (mob.hp <= 0) break;
    player.hp -= mob.str;
  }
  if (player.hp <= 0) log += "☠️ You were defeated!";
  else {
    player.xp += 10;
    player.gold += 3;
    player.inventory.push("Herb");
    log += "✅ Victory! +10 XP, +3g, Herb found.";
  }
  update(log);
}

function showInventory() {
  alert("🎒 " + (player.inventory.join(', ') || 'Empty'));
}

function craft() {
  const i = player.inventory;
  if (i.filter(x => x === "Herb").length >= 2) {
    i.splice(i.indexOf("Herb"), 1);
    i.splice(i.indexOf("Herb"), 1);
    i.push("Healing Brew");
    alert("🧪 Crafted Healing Brew.");
  } else {
    alert("❌ Not enough materials.");
  }
  update("🧪 Crafting complete.");
}

function shop() {
  const buy = prompt("Shop:
1. Herb (3g)\n2. Shield (+1 max HP, 5g)");
  if (buy === "1" && player.gold >= 3) {
    player.gold -= 3;
    player.inventory.push("Herb");
    update("🛍 Bought Herb.");
  } else if (buy === "2" && player.gold >= 5) {
    player.gold -= 5;
    player.maxHp += 1;
    update("🛡 Bought and equipped Shield. Max HP +1");
  } else {
    alert("❌ Can't afford that.");
  }
}

markVisited();
update("🌟 Welcome to Elden Paths (Phase 23)");
</script>

</body>
</html>

