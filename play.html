<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elden Paths™ — Phase 25 (NPCs + Dialogue)</title>
  <style>
    body { font-family: monospace; background: #f4f4f4; padding: 2em; }
    #out { white-space: pre-wrap; padding: 1em; background: #eee; border-radius: 6px; margin-bottom: 1em; max-width: 700px; }
    button { margin: 4px; }
    #mapModal {
      display: none;
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      padding: 1em;
      border: 2px solid #333;
      z-index: 1000;
    }
    #mapModal pre { font-size: 16px; line-height: 1.2em; cursor: pointer; }
  </style>
</head>
<body>

<h1>📖 Elden Paths™</h1>
<div id="out">Loading...</div>

<button onclick="move('north')">⬆️ Go North</button>
<button onclick="move('south')">⬇️ Go South</button>
<button onclick="move('east')">➡️ Go East</button>
<button onclick="move('west')">⬅️ Go West</button>
<button onclick="descend()">⛏ Descend</button>
<button onclick="ascend()">🛗 Ascend</button><br>
<button onclick="fight()">⚔️ Fight</button>
<button onclick="rest()">🌊 Rest</button>
<button onclick="craft()">🔧 Craft</button>
<button onclick="shop()">🏪 Shop</button>
<button onclick="renderMap()">🗺 Show Map</button>
<button onclick="showInventory()">🎒 Inventory</button>

<div id="mapModal">
  <pre id="mapGrid"></pre>
  <button onclick="document.getElementById('mapModal').style.display='none'">Close Map</button>
</div>

<script>
const name = prompt("Enter your name:");
let player = {
  name,
  tile: "0,0",
  z: 0,
  visited: [],
  inventory: [],
  hp: 10,
  maxHp: 10,
  str: 5,
  level: 1,
  xp: 0,
  gear: {},
  gold: 0,
  flags: {},
  timeBelow: 0
};

const tileIcons = {
  "0,0": "🏡",
  "C4": "🏰",
  "E5": "🔒"
};

const npcs = {
  "A1,0": () => {
    if (player.flags.bossCleared && !player.flags.mayorReward) {
      player.flags.mayorReward = true;
      player.gold += 10;
      alert("🧓 Mayor: Brave soul! The beast is gone? Here, take this — 10 gold.");
    } else if (player.flags.bossCleared) {
      alert("🧓 Mayor: You’ve already proven yourself.");
    } else {
      alert("🧓 Mayor: We fear the creature in the ruins...");
    }
  },
  "D5,0": () => {
    if (!player.flags.bossCleared) {
      alert("🤕 Wounded Knight: Beware... the beast still lives...");
    } else {
      alert("🤕 Wounded Knight: You did it... we are avenged.");
    }
  }
};

function tileKey(x, y, z) {
  return `${x},${y},${z}`;
}

function markVisited() {
  const key = tileKey(...player.tile.split(',').map(Number), player.z);
  if (!player.visited.includes(key)) player.visited.push(key);
}

function renderMap() {
  const [px, py] = player.tile.split(',').map(Number);
  const z = player.z;
  const label = z === 0 ? 'Surface' : (z < 0 ? 'Underground' : `Z=${z}`);
  let output = `🗺 Map View — ${label} (5x5):\n\n`;
  for (let y = py + 2; y >= py - 2; y--) {
    for (let x = px - 2; x <= px + 2; x++) {
      const key = tileKey(x, y, z);
      let char = ".";
      if (player.tile === `${x},${y}`) char = "@";
      else if (player.visited.includes(key)) char = tileIcons[`${x},${y}`] || "#";
      output += `<span onclick=\"travelTo('${x},${y}', ${z})\">${char}</span> `;
    }
    output += "\n";
  }
  document.getElementById("mapGrid").innerHTML = output;
  document.getElementById("mapModal").style.display = "block";
}

function travelTo(coord, zTarget) {
  if (zTarget !== player.z) return alert("⛔ Can't travel between layers.");
  const key = tileKey(...coord.split(',').map(Number), zTarget);
  if (!player.visited.includes(key)) return alert("❌ Fogged tile.");
  player.tile = coord;
  markVisited();
  update(`🧭 Traveled to ${coord}`);
  document.getElementById("mapModal").style.display = "none";
}

function update(log = "") {
  const status =
    `🧝 ${player.name} | ❤️ ${player.hp}/${player.maxHp} | ⚔️ ${player.str} | 🌟 Level ${player.level}\n` +
    `📍 Tile: ${player.tile}, z=${player.z} | 💰 ${player.gold}g\n` +
    `🎒 ${player.inventory.join(', ') || 'Empty'}`;
  if (player.z < 0) {
    player.timeBelow++;
    if (player.timeBelow > 5 && !player.flags.deepWarning) {
      player.flags.deepWarning = true;
      log += "\n☁️ You feel the weight of the stone above...";
    }
  } else {
    player.timeBelow = 0;
  }
  document.getElementById("out").textContent = `${log}\n\n${status}`;
}

function move(dir) {
  let [x, y] = player.tile.split(',').map(Number);
  if (dir === 'north') y++;
  if (dir === 'south') y--;
  if (dir === 'east') x++;
  if (dir === 'west') x--;
  player.tile = `${x},${y}`;
  markVisited();
  let log = `🚶 Moved ${dir.toUpperCase()} to ${player.tile}`;
  checkTriggers(log);
}

function descend() {
  if (player.z === 0 && player.tile === "C4") {
    player.z = -1;
    markVisited();
    update("⛏ You descend into the catacombs...");
  } else {
    alert("❌ No descent here.");
  }
}

function ascend() {
  if (player.z < 0) {
    player.z = 0;
    markVisited();
    update("🛗 You climb back to the surface.");
  } else {
    alert("⚠️ You're already on the surface.");
  }
}

function checkTriggers(log) {
  const key = `${player.tile},${player.z}`;
  if (npcs[key]) npcs[key]();

  if (player.tile === "D5" && !player.flags.bossCleared) {
    player.flags.bossCleared = true;
    player.xp += 20;
    log += "\n💀 Dungeon beast defeated! +20 XP.";
  }
  if (player.tile === "A1" && player.flags.bossCleared && !player.flags.townEvent) {
    player.flags.townEvent = true;
    log += "\n🎉 Town celebrates your return!";
  }
  update(log);
}

function rest() {
  const healed = Math.min(player.maxHp - player.hp, 4);
  player.hp += healed;
  update(`🛌 Rested +${healed} HP.`);
}

function fight() {
  const mob = { hp: 6, str: 3 };
  let log = "⚔️ Battle begins!\n";
  while (mob.hp > 0 && player.hp > 0) {
    mob.hp -= player.str;
    if (mob.hp <= 0) break;
    player.hp -= mob.str;
  }
  if (player.hp <= 0) log += "☠️ You were defeated!";
  else {
    player.xp += 10;
    player.gold += 3;
    player.inventory.push("Herb");
    log += "✅ Victory! +10 XP, +3g, Herb found.";
  }
  update(log);
}

function showInventory() {
  alert("🎒 " + (player.inventory.join(', ') || 'Empty'));
}

function craft() {
  const i = player.inventory;
  if (i.filter(x => x === "Herb").length >= 2) {
    i.splice(i.indexOf("Herb"), 1);
    i.splice(i.indexOf("Herb"), 1);
    i.push("Healing Brew");
    alert("🧪 Crafted Healing Brew.");
  } else {
    alert("❌ Not enough materials.");
  }
  update("🧪 Crafting complete.");
}

function shop() {
  const buy = prompt("Shop:\n1. Herb (3g)\n2. Shield (+1 max HP, 5g)");
  if (buy === "1" && player.gold >= 3) {
    player.gold -= 3;
    player.inventory.push("Herb");
    update("🛍 Bought Herb.");
  } else if (buy === "2" && player.gold >= 5) {
    player.gold -= 5;
    player.maxHp += 1;
    update("🛡 Bought and equipped Shield. Max HP +1");
  } else {
    alert("❌ Can't afford that.");
  }
}

markVisited();
update("🌟 Welcome to Elden Paths (Phase 25)");
</script>

</body>
</html>
