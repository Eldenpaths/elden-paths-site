<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elden Paths‚Ñ¢ ‚Äî Map & Fog</title>
  <style>
    body { font-family: monospace; padding: 1em; background: #f3f3f3; }
    #out { white-space: pre-wrap; background: #eee; padding: 1em; border-radius: 8px; margin-bottom: 1em; }
    button, select { margin: 0.25em; }
  </style>
</head>
<body>
  <h1>Elden Paths‚Ñ¢ ‚Äî Map & Fog</h1>

  <div id="out">Loading...</div>

  <div id="play" class="hidden">
    <button onclick="move('north')">Go North</button>
    <button onclick="move('south')">Go South</button>
    <button onclick="move('east')">Go East</button>
    <button onclick="move('west')">Go West</button>
    <br/>
    <button onclick="fight()">‚öîÔ∏è Fight Goblin</button>
  </div>

  <script>
    const api = 'https://player-save.pationandcamp.workers.dev';
    let player = {};
    const gridRows = ['A', 'B', 'C', 'D'];
    const gridCols = [1, 2, 3, 4];

    const roll = (d = 20) => Math.floor(Math.random() * d) + 1;

    function output(txt) {
      document.getElementById('out').textContent = txt;
    }

    function render() {
      document.getElementById('play').classList.remove('hidden');
      output(`
üìç Tile: ${player.tile}
üß≠ Fog of Discovery: ${player.fog.join(', ')}

Name: ${player.name}
Race: ${player.race}, Class: ${player.class}
HP: ${player.hp}, XP: ${player.xp}, Level: ${player.level}
STR: ${player.stats.str}, DEX: ${player.stats.dex}, INT: ${player.stats.int}
Gold: ${player.gold}
Conditions: ${player.conditions.join(', ') || 'None'}
Last Seen: ${player.lastSeen}
      `.trim());
    }

    async function load() {
      const name = new URLSearchParams(location.search).get('name');
      if (!name) return output("Missing ?name= parameter.");
      const res = await fetch(`${api}/loadPlayer?name=${name}`);
      if (res.ok) {
        player = await res.json();
        if (!player.tile) player.tile = "B2";
        if (!player.fog) player.fog = [player.tile];
        render();
      } else {
        output("Player not found.");
      }
    }

    async function save() {
      player.lastSeen = new Date().toISOString();
      await fetch(`${api}/savePlayer`, {
        method: 'POST',
        body: JSON.stringify(player)
      });
      render();
    }

    function tileToCoord(tile) {
      const row = tile[0];
      const col = parseInt(tile[1]);
      return [gridRows.indexOf(row), gridCols.indexOf(col)];
    }

    function coordToTile(r, c) {
      if (r < 0 || r >= gridRows.length || c < 0 || c >= gridCols.length) return null;
      return `${gridRows[r]}${gridCols[c]}`;
    }

    async function move(dir) {
      let [r, c] = tileToCoord(player.tile);
      if (dir === 'north') r -= 1;
      if (dir === 'south') r += 1;
      if (dir === 'west') c -= 1;
      if (dir === 'east') c += 1;

      const newTile = coordToTile(r, c);
      if (!newTile) {
        output("You can't go that way.\n\n" + document.getElementById('out').textContent);
        return;
      }

      player.tile = newTile;
      if (!player.fog.includes(newTile)) {
        player.fog.push(newTile);
        output(`üó∫Ô∏è New tile discovered: ${newTile}!\n\n` + document.getElementById('out').textContent);
      } else {
        output(`You travel to ${newTile}.\n\n` + document.getElementById('out').textContent);
      }

      await save();
    }

    async function fight() {
      const goblin = { hp: 5, ac: 12, atk: 2 };
      const pRoll = roll(20) + player.stats.str;
      const gRoll = roll(20) + goblin.atk;
      let log = `You roll to hit: ${pRoll} vs AC ${goblin.ac}\n`;

      if (pRoll >= goblin.ac) {
        const dmg = roll(4);
        goblin.hp -= dmg;
        player.xp += 10;
        log += `‚úÖ Hit! You deal ${dmg} to Goblin. +10 XP\n`;
      } else {
        log += `‚ùå You missed.\n`;
      }

      if (gRoll >= 12) {
        const dmg = roll(4);
        player.hp -= dmg;
        player.conditions.push("Wounded");
        log += `üí• Goblin hits you for ${dmg}. HP now ${player.hp}\n`;
      } else {
        log += `üõ°Ô∏è Goblin missed.\n`;
      }

      await save();
      output(log + '\n---\n' + document.getElementById('out').textContent);
    }

    load();
  </script>
</body>
</html>

