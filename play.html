<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elden Pathsâ„¢ â€” Towns & Vendors</title>
  <style>
    body { font-family: monospace; background: #f4f4f4; padding: 2em; }
    #out { white-space: pre-wrap; padding: 1em; background: #eee; border-radius: 6px; margin-bottom: 1em; max-width: 700px; }
    button { margin: 4px; }
  </style>
</head>
<body>

<h1>ğŸ“– Elden Pathsâ„¢</h1>
<div id="out">Loading...</div>

<button onclick="move('north')">â¬†ï¸ Go North</button>
<button onclick="move('south')">â¬‡ï¸ Go South</button>
<button onclick="move('east')">â¡ï¸ Go East</button>
<button onclick="move('west')">â¬…ï¸ Go West</button><br>
<button onclick="fight()">âš”ï¸ Fight</button>
<button onclick="rest()">ğŸ›Œ Rest</button>
<button onclick="shop()">ğŸª Town Action</button>
<button onclick="showInventory()">ğŸ’ Inventory</button>
<button onclick="showJournal()">ğŸ““ Journal</button>
<button onclick="showQuests()">ğŸ“œ Quests</button>

<script>
const api = "https://player-save.pationandcamp.workers.dev";
const name = new URLSearchParams(location.search).get("name") || prompt("Enter your name:");
let player = null;

const loreByTile = {
  "B1": "ğŸ—¿ You find a cracked statue lying in the weeds.",
  "C2": "â›©ï¸ An ancient altar glows faintly in the dusk.",
  "D3": "ğŸ”¥ Burnt wagons and splintered wood mark a destroyed caravan."
};

const questByTile = {
  "A2": "ğŸŒ¿ Quest: Gather herbs for the village healer.",
  "C1": "ğŸ§± Quest: Investigate the collapsed mineshaft.",
  "D4": "ğŸ“¦ Quest: Recover the lost trader's chest."
};

const enemyByTile = {
  "B2": { name: "Goblin", hp: 6, str: 3 },
  "C3": { name: "Wild Wolf", hp: 8, str: 4 },
  "D2": { name: "Undead Shade", hp: 10, str: 5 },
  "E4": { name: "Grave Knight", hp: 20, str: 6, boss: true }
};

const towns = {
  "A1": "Willowmere",
  "B3": "Stonecross",
  "D4": "Gravesend"
};

function xpForNextLevel(level) {
  return level * 10 + (level - 1) * 10;
}

async function loadPlayer() {
  const res = await fetch(`${api}/loadPlayer?name=${encodeURIComponent(name)}`);
  if (res.ok) {
    player = await res.json();
  } else {
    player = {
      name,
      hp: 10,
      maxHp: 10,
      str: 5,
      xp: 0,
      level: 1,
      tile: '0,0',
      inventory: [],
      gear: { weapon: null },
      journal: [],
      quests: [],
      gold: 0
    };
    await savePlayer();
  }
  update();
}

async function savePlayer() {
  await fetch(`${api}/savePlayer`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(player)
  });
}

function update(log = "") {
  const status =
    `ğŸ§ ${player.name} | â¤ï¸ ${player.hp}/${player.maxHp} | âš”ï¸ STR: ${player.str} ${player.gear.weapon ? `(w/ ${player.gear.weapon})` : ''}\n` +
    `ğŸ–ï¸ XP: ${player.xp} | Level: ${player.level} | ğŸ’° Gold: ${player.gold}\n` +
    `ğŸ“ Tile: ${player.tile} ${towns[player.tile] ? `â€” ğŸ˜ ${towns[player.tile]}` : ''}\nğŸ’ ${player.inventory.join(', ') || 'Empty'}`;
  document.getElementById('out').textContent = `${log}\n\n${status}`;
}

function checkLevelUp() {
  while (player.xp >= xpForNextLevel(player.level)) {
    player.xp -= xpForNextLevel(player.level);
    player.level++;
    player.maxHp += 2;
    if (player.level % 2 === 0) player.str += 1;
    player.hp = player.maxHp;
    alert(`ğŸ‰ You reached Level ${player.level}!\nMax HP: ${player.maxHp}, STR: ${player.str}`);
  }
}

async function move(dir) {
  let [x, y] = player.tile.split(',').map(Number);
  if (dir === 'north') y++;
  if (dir === 'south') y--;
  if (dir === 'east') x++;
  if (dir === 'west') x--;
  player.tile = `${x},${y}`;

  let log = `ğŸš¶ You travel ${dir.toUpperCase()} to tile ${player.tile}`;

  const lore = loreByTile[player.tile];
  if (lore && !player.journal.includes(lore)) {
    player.journal.push(lore);
    log += `\nğŸ“œ New Lore: ${lore}`;
  }

  const quest = questByTile[player.tile];
  if (quest && !player.quests.includes(quest)) {
    player.quests.push(quest);
    log += `\nğŸ†• Quest Found: ${quest}`;
  }

  await savePlayer();
  update(log);
}

async function fight() {
  const enemy = enemyByTile[player.tile];
  if (!enemy) return update("âŒ There is no enemy here.");

  let monster = { ...enemy };
  let log = `âš”ï¸ You engage the ${monster.name}!\n`;

  while (player.hp > 0 && monster.hp > 0) {
    monster.hp -= player.str;
    log += `ğŸ—¡ï¸ You hit for ${player.str}. ${monster.name} HP: ${monster.hp}\n`;
    if (monster.hp <= 0) break;
    player.hp -= monster.str;
    log += `ğŸ’¢ ${monster.name} hits for ${monster.str}. Your HP: ${player.hp}\n`;
  }

  if (player.hp <= 0) {
    log += `â˜ ï¸ You were slain by the ${monster.name}.`;
  } else {
    const goldEarned = monster.boss ? Math.floor(Math.random() * 11) + 10 : Math.floor(Math.random() * 6) + 1;
    player.gold += goldEarned;

    let reward = monster.boss ? 30 : 10;
    let loot = monster.boss ? "Darkblade" : (Math.random() < 0.5 ? "Herb" : "Rusty Sword");
    player.xp += reward;
    player.inventory.push(loot);
    log += `âœ… Victory! +${reward} XP, ğŸ’° +${goldEarned}g\nğŸ Loot: ${loot}`;

    if (loot === "Rusty Sword" && !player.gear.weapon) {
      player.gear.weapon = "Rusty Sword";
      player.str += 2;
      log += `\nğŸ—¡ï¸ You equip the Rusty Sword (+2 STR)!`;
    }

    if (loot === "Darkblade") {
      if (player.gear.weapon === "Rusty Sword") player.str -= 2;
      player.gear.weapon = "Darkblade";
      player.str += 4;
      log += `\nğŸ—¡ï¸ You equip the Darkblade (+4 STR)!`;
    }

    checkLevelUp();
  }

  await savePlayer();
  update(log);
}

async function rest() {
  const healed = Math.min(player.maxHp - player.hp, 4);
  player.hp += healed;
  await savePlayer();
  update(healed > 0 ? `ğŸ›Œ You rest and heal ${healed} HP.` : `ğŸ›Œ You're already at full health.`);
}

async function shop() {
  const tile = player.tile;

  if (tile === "A1") {
    player.hp = player.maxHp;
    await savePlayer();
    return update(`ğŸŒ¿ Willowmere spring restores your health to full.`);
  }

  if (tile === "B3") {
    let choice = prompt("ğŸ› Stonecross Shop:\n1. Herb (3g)\n2. Wooden Shield (+1 HP buffer) (5g)\nEnter 1 or 2:");
    if (choice === "1" && player.gold >= 3) {
      player.gold -= 3;
      player.inventory.push("Herb");
      update("ğŸª™ You bought a Herb.");
    } else if (choice === "2" && player.gold >= 5) {
      player.gold -= 5;
      player.maxHp += 1;
      update("ğŸ›¡ï¸ You equip a Wooden Shield. Max HP +1.");
    } else {
      update("âŒ Not enough gold or invalid choice.");
    }
    await savePlayer();
    return;
  }

  if (tile === "D4") {
    let choice = prompt("âš”ï¸ Gravesend Forge:\n1. Steel Sword (+3 STR) (10g)\n2. Darkblade (+4 STR) (25g)\nEnter 1 or 2:");
    if (choice === "1" && player.gold >= 10) {
      if (player.gear.weapon) player.str -= player.gear.weapon === "Rusty Sword" ? 2 : player.gear.weapon === "Darkblade" ? 4 : 0;
      player.gear.weapon = "Steel Sword";
      player.str += 3;
      player.gold -= 10;
      update("ğŸ› ï¸ You bought a Steel Sword. STR +3.");
    } else if (choice === "2" && player.gold >= 25) {
      if (player.gear.weapon) player.str -= player.gear.weapon === "Rusty Sword" ? 2 : player.gear.weapon === "Steel Sword" ? 3 : 0;
      player.gear.weapon = "Darkblade";
      player.str += 4;
      player.gold -= 25;
      update("ğŸ’€ You wield the Darkblade. STR +4.");
    } else {
      update("âŒ Not enough gold or invalid choice.");
    }
    await savePlayer();
    return;
  }

  update("âŒ There's no shop at this location.");
}

async function showInventory() {
  if (!player.inventory.length) return alert("ğŸ’ Your inventory is empty.");
  let msg = `ğŸ’ You have: ${player.inventory.join(', ')}`;
  if (player.inventory.includes("Herb")) {
    const use = confirm("Use a Herb to heal 3 HP?");
    if (use) {
      player.hp = Math.min(player.hp + 3, player.maxHp);
      player.inventory.splice(player.inventory.indexOf("Herb"), 1);
      msg += `\nğŸŒ¿ You used a Herb. HP: ${player.hp}/${player.maxHp}`;
      await savePlayer();
    }
  }
  alert(msg);
  update();
}

function showJournal() {
  if (!player.journal.length) return alert("ğŸ““ Your journal is empty.");
  alert("ğŸ““ Lore Entries:\n\n" + player.journal.join('\n\n'));
}

function showQuests() {
  if (!player.quests.length) return alert("ğŸ“œ You have no quests yet.");
  alert("ğŸ“œ Active Quests:\n\n" + player.quests.join('\n\n'));
}

loadPlayer();
</script>

</body>
</html>
