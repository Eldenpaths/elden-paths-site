
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Builder Cache Auto-Scan Panel</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #eee; padding: 1rem; }
    h1, h2 { color: #9f9; }
    .tile { margin: 1rem 0; padding: 1rem; border: 1px solid #444; background: #222; }
    .tile span { display: block; font-family: monospace; color: #ccc; }
    .btn { background: #5a5; color: #111; padding: 0.5rem 1rem; border: none; font-weight: bold; text-decoration: none; margin-top: 0.5rem; display: inline-block; }
    .btn:hover { background: #6d6; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Builder Cache Tile Scanner</h1>
  <p>This panel scans and displays all tiles currently cached by the Echo Compilerâ„¢ system.</p>
  <div id="tileList">Loading cache...</div>

  <script>
    async function loadTiles() {
      try {
        const response = await fetch('/builder_cache/');
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const links = [...doc.querySelectorAll('a')].map(a => a.href);
        const tileMap = {};

        links.forEach(link => {
          const parts = link.split('/').pop().split('_');
          const base = parts.slice(0, 3).join('_');
          const ext = link.split('.').pop();

          if (!tileMap[base]) tileMap[base] = {};
          if (ext === 'json') tileMap[base].voxel = link;
          if (ext === 'gltf') tileMap[base].struct = link;
          if (ext === 'png' && link.includes('fog')) tileMap[base].fog = link;
          if (ext === 'png' && !link.includes('fog')) tileMap[base].sketch = link;
        });

        const output = Object.entries(tileMap).map(([id, files]) => {
          return `
            <div class="tile">
              <span><strong>Tile ID:</strong> ${id}</span>
              ${files.sketch ? `<span>Sketch: <code>${files.sketch}</code></span>` : ''}
              ${files.voxel ? `<span>Voxel: <code>${files.voxel}</code></span>` : ''}
              ${files.fog ? `<span>Fog: <code>${files.fog}</code></span>` : ''}
              ${files.struct ? `<span>Struct: <code>${files.struct}</code></span>` : ''}
              <a href="/admin/builder_cache_preview.html" class="btn" target="_blank">Preview Sketch</a>
              ${files.voxel ? `<a href="${files.voxel}" class="btn" download>Download Voxel</a>` : ''}
              ${files.struct ? `<a href="${files.struct}" class="btn" download>Download Structure</a>` : ''}
            </div>
          `;
        }).join('');

        document.getElementById('tileList').innerHTML = output || '<p>No tiles found.</p>';
      } catch (err) {
        document.getElementById('tileList').innerHTML = '<p style="color:red;">Error loading cache directory. Make sure directory listing is enabled on your server.</p>';
      }
    }

    loadTiles();
  </script>
</body>
</html>
