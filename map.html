
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Elden Paths ‚Äì Player Map</title>
  <style>
    body {
      font-family: 'Georgia', serif;
      background: #f5f2e7;
      color: #2d1b00;
      text-align: center;
      padding: 1rem;
    }
    #map-controls {
      margin-bottom: 1rem;
    }
    .btn {
      padding: 6px 12px;
      margin: 4px;
      background: #e0d8c3;
      border: 1px solid #888;
      cursor: pointer;
    }
    #map {
      display: grid;
      gap: 2px;
      margin: 1rem auto;
      width: fit-content;
    }
    .tile {
      width: 48px;
      height: 48px;
      position: relative;
      background: #ddd4bb;
      border: 1px solid #bbb;
      font-size: 10px;
      overflow: hidden;
    }
    .tile img {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      opacity: 0.3;
      object-fit: cover;
      z-index: 0;
    }
    .tile span {
      position: relative;
      z-index: 1;
      color: #222;
      font-weight: bold;
    }
    .fogged {
      background: #888 !important;
    }
    .player {
      background: #334 !important;
      color: #fff;
    }
    #terrain-box {
      margin-top: 2rem;
    }
    #terrain-img {
      width: 200px;
      border: 2px solid #ccc;
      border-radius: 6px;
    }
    .lore-popup {
      position: absolute;
      background: #fff8dc;
      border: 1px solid #aa9;
      padding: 4px 8px;
      font-size: 10px;
      z-index: 10;
      display: none;
    }
  </style>
</head>
<body>
  <h2>üó∫Ô∏è Elden Paths ‚Äî Player Map</h2>
  <div id="map-controls">
    
<button class="btn" onclick="toggleFog()">Toggle Fog (DM)</button>
<a href="play.html"><button class="btn">Return to Game</button></a>

    <button class="btn" onclick="setZoom(1)">Mini (1x)</button>
    <button class="btn" onclick="setZoom(5)">Local (5x)</button>
    <button class="btn" onclick="setZoom(10)">Region (10x)</button>
    <button class="btn" onclick="setZoom(20)">World (20x)</button>
  </div>

  <p id="infoText">Loading...</p>
  
  <div id="calendar-bar" style="margin-top: 1rem; font-weight: bold;">
    üåó <span id="calendarText">Loading in-world date...</span>
  </div>

  <div id="map"></div>

  <div id="terrain-box">
    <h3 id="terrain-name">Terrain Preview</h3>
    <img id="terrain-img" src="" alt="Tile sketch" />
  </div>

  <div id="lore-box" class="lore-popup"></div>

  <script>
    let playerName = "test_player";
    let zoomLevel = 5;
    const mapElement = document.getElementById("map");
    const infoText = document.getElementById("infoText");
    const loreBox = document.getElementById("lore-box");

    let terrainMeta = {};
    let playerData = {};
    let fogData = {};
    let loreData = {};

    
    let trailsData = {};
    let relicsData = {};
    let weatherData = {};
    let calendarData = {};
    let eventLog = {};
    let tileMeta = {};
    let tileEchoes = {};
    let structuresData = {};

    async function loadData() {
      terrainMeta = (await fetch('meta.json').then(r => r.json())).tiles || {};
      playerData = (await fetch('players.json').then(r => r.json()))[playerName];
      fogData = (await fetch('fog.json').then(r => r.json()))[playerName]?.discovered || [];
      try {
        loreData = await fetch('tile_lore.json').then(r => r.json());
      } catch (e) {
        loreData = {};
      }
      try {
        trailsData = await fetch('trails.json').then(r => r.json());
      } catch (e) {
        trailsData = {};
      }
      try {
        structuresData = await fetch('structures.json').then(r => r.json());
      } catch (e) {
        structuresData = {};
      }
      try { relicsData = await fetch("relics.json").then(r => r.json()); } catch { relicsData = {}; }
      try { weatherData = await fetch("weather.json").then(r => r.json()); } catch { weatherData = {}; }
      try { calendarData = await fetch("calendar.json").then(r => r.json()); } catch { calendarData = {}; }
try { eventLog = await fetch("event_log.json").then(r => r.json()); } catch { eventLog = {}; }
buildMap()

      const calText = document.getElementById("calendarText");
      if (calendarData && calText) {
        calText.innerText = `Day ${calendarData.day} ¬∑ Season: ${calendarData.season} ¬∑ Moon: ${calendarData.moon} ¬∑ Tide: ${calendarData.tide} ¬∑ Event: ${calendarData.event}`;
      }
;
    }
 {
      terrainMeta = (await fetch('meta.json').then(r => r.json())).tiles || {};
      playerData = (await fetch('players.json').then(r => r.json()))[playerName];
      fogData = (await fetch('fog.json').then(r => r.json()))[playerName]?.discovered || [];
      try {
        loreData = await fetch('tile_lore.json').then(r => r.json());
      } catch (e) {
        loreData = {};
      }
      try { relicsData = await fetch("relics.json").then(r => r.json()); } catch { relicsData = {}; }
      try { weatherData = await fetch("weather.json").then(r => r.json()); } catch { weatherData = {}; }
      try { calendarData = await fetch("calendar.json").then(r => r.json()); } catch { calendarData = {}; }
try { eventLog = await fetch("event_log.json").then(r => r.json()); } catch { eventLog = {}; }
buildMap()

      const calText = document.getElementById("calendarText");
      if (calendarData && calText) {
        calText.innerText = `Day ${calendarData.day} ¬∑ Season: ${calendarData.season} ¬∑ Moon: ${calendarData.moon} ¬∑ Tide: ${calendarData.tide} ¬∑ Event: ${calendarData.event}`;
      }
;
    }

    function setZoom(level) {
      zoomLevel = level;
      try { relicsData = await fetch("relics.json").then(r => r.json()); } catch { relicsData = {}; }
      try { weatherData = await fetch("weather.json").then(r => r.json()); } catch { weatherData = {}; }
      try { calendarData = await fetch("calendar.json").then(r => r.json()); } catch { calendarData = {}; }
try { eventLog = await fetch("event_log.json").then(r => r.json()); } catch { eventLog = {}; }
buildMap()

      const calText = document.getElementById("calendarText");
      if (calendarData && calText) {
        calText.innerText = `Day ${calendarData.day} ¬∑ Season: ${calendarData.season} ¬∑ Moon: ${calendarData.moon} ¬∑ Tide: ${calendarData.tide} ¬∑ Event: ${calendarData.event}`;
      }
;
    }

    
    let fogEnabled = true;
    function toggleFog() {
      fogEnabled = !fogEnabled;
      try { relicsData = await fetch("relics.json").then(r => r.json()); } catch { relicsData = {}; }
      try { weatherData = await fetch("weather.json").then(r => r.json()); } catch { weatherData = {}; }
      try { calendarData = await fetch("calendar.json").then(r => r.json()); } catch { calendarData = {}; }
try { eventLog = await fetch("event_log.json").then(r => r.json()); } catch { eventLog = {}; }
buildMap()

      const calText = document.getElementById("calendarText");
      if (calendarData && calText) {
        calText.innerText = `Day ${calendarData.day} ¬∑ Season: ${calendarData.season} ¬∑ Moon: ${calendarData.moon} ¬∑ Tide: ${calendarData.tide} ¬∑ Event: ${calendarData.event}`;
      }
;
    }

function buildMap()

      const calText = document.getElementById("calendarText");
      if (calendarData && calText) {
        calText.innerText = `Day ${calendarData.day} ¬∑ Season: ${calendarData.season} ¬∑ Moon: ${calendarData.moon} ¬∑ Tide: ${calendarData.tide} ¬∑ Event: ${calendarData.event}`;
      }
 {
      const [px, py] = playerData.tile.split(',').map(Number);
      const size = zoomLevel;
      const half = Math.floor(size / 2);
      mapElement.innerHTML = '';
      mapElement.style.gridTemplateColumns = `repeat(${size}, 1fr)`;

      for (let y = py - half; y <= py + half; y++) {
        for (let x = px - half; x <= px + half; x++) {
          const coord = `${x},${y}`;
          const tileData = terrainMeta[coord] || {};
          const isDiscovered = fogData.includes(coord);
          const div = document.createElement('div');
          div.className = 'tile';
          if (!isDiscovered && fogEnabled) div.classList.add('fogged');
          if (coord === playerData.tile) div.classList.add('player');

          if (tileData.sketch && isDiscovered) {
            const img = document.createElement('img');
            img.src = `/assets/img/tiles/${tileData.sketch}`;
            div.appendChild(img);
          }

          const label = document.createElement('span');
          label.innerText = tileData.terrain ? tileData.terrain[0].toUpperCase() : '?';
          div.appendChild(label);

          if (loreData[coord] && isDiscovered) {
            div.addEventListener('mouseover', (e) => {
              loreBox.style.left = e.pageX + 'px';
              loreBox.style.top = e.pageY + 'px';
              loreBox.style.display = 'block';
              loreBox.innerHTML = `<strong>${loreData[coord].title}</strong><br/>${loreData[coord].text}`;
            });
            div.addEventListener('mouseout', () => {
              loreBox.style.display = 'none';
            });
          }

          
          // Trails: background border glow (optional style layer)
          if (trailsData[coord] && isDiscovered && fogEnabled) {
            const v = trailsData[coord].visibility;
            div.style.boxShadow = `0 0 ${v * 10}px ${v * 4}px rgba(100, 100, 50, ${v})`;
          }

          // Structures: emoji icon overlay
          if (structuresData[coord] && isDiscovered) {
            const mark = document.createElement('span');
            mark.style.position = 'absolute';
            mark.style.bottom = '2px';
            mark.style.right = '2px';
            mark.style.fontSize = '14px';
            mark.innerText = structuresData[coord].type === 'fort' ? 'üè∞' :
                             structuresData[coord].type === 'ruin' ? 'üèö' : 'üè†';
            div.appendChild(mark);
            div.title = structuresData[coord].name + ' ‚Äî ' + (structuresData[coord].lore || '');
          }

          
          // Relics: glow + icon
          if (relicsData[coord] && isDiscovered) {
            const relic = relicsData[coord];
            const relicMark = document.createElement('span');
            relicMark.style.position = 'absolute';
            relicMark.style.top = '2px';
            relicMark.style.left = '2px';
            relicMark.style.fontSize = '14px';
            relicMark.innerText = '‚ú®';
            div.appendChild(relicMark);
            div.title = relic.name + ' ‚Äî ' + (relic.lore || '');
            div.style.outline = '2px solid gold';
          }

          
          // Weather overlay icon
          if (weatherData[coord]) {
            const w = weatherData[coord];
            const wIcon = document.createElement('div');
            wIcon.style.position = 'absolute';
            wIcon.style.top = '0';
            wIcon.style.right = '0';
            wIcon.style.fontSize = '12px';
            wIcon.innerText =
              w.condition === 'sun' ? '‚òÄÔ∏è' :
              w.condition === 'rain' ? 'üåßÔ∏è' :
              w.condition === 'fog' ? 'üå´Ô∏è' :
              w.condition === 'storm' ? '‚õàÔ∏è' :
              w.condition === 'snow' ? '‚ùÑÔ∏è' : '';
            wIcon.title = `${w.condition.charAt(0).toUpperCase() + w.condition.slice(1)} ‚Äî ${w.intensity} ‚Äî ${w.temp}¬∞F`;
            div.appendChild(wIcon);
          }

          
          if (eventLog.events) {
            const eventsHere = eventLog.events.filter(e => e.tile === coord);
            if (eventsHere.length > 0) {
              const mark = document.createElement('div');
              mark.className = 'marker';
              mark.style.color = 'crimson';
              mark.innerText = 'üåÄ';
              tile.appendChild(mark);
              const titles = eventsHere.map(e => e.title).join(", ");
              tile.title = (tile.title ? tile.title + "\n" : "") + "Events: " + titles;
            }
          }

          
          // Tide-aware tile filter
          if (tileMeta[coord]?.shoreline && calendarData?.tide) {
            const tideFilter = document.createElement('div');
            tideFilter.style.position = 'absolute';
            tideFilter.style.top = '0';
            tideFilter.style.left = '0';
            tideFilter.style.width = '100%';
            tideFilter.style.height = '100%';
            tideFilter.style.zIndex = '2';
            tideFilter.style.backgroundColor =
              calendarData.tide === 'high' ? 'rgba(0, 80, 180, 0.25)' :
              calendarData.tide === 'low' ? 'rgba(240, 230, 190, 0.2)' : 'transparent';
            tile.appendChild(tideFilter);
            tile.title = (tile.title ? tile.title + "\n" : "") + "Tide: " + calendarData.tide;
          }

          
          if (tileEchoes[coord]) {
            const echo = document.createElement('div');
            echo.className = 'marker';
            echo.style.color = 'purple';
            echo.innerText = 'üïØÔ∏è';
            tile.appendChild(echo);
            const details = tileEchoes[coord].map(e => `${e.player} ${e.action} (Day ${e.day})`).join("\n");
            tile.title = (tile.title ? tile.title + "\n" : "") + "Echoes:\n" + details;
          }

          mapElement.appendChild(div);
        }
      }

      const current = terrainMeta[playerData.tile] || {};
      infoText.innerText = `Tile: ${playerData.tile} | Region: ${current.region || 'Unknown'} | Terrain: ${current.terrain || '??'} | Elevation: ${current.elevation || '-'}`;

      const sketch = current.sketch;
      if (sketch) {
        document.getElementById("terrain-img").src = `/assets/img/tiles/${sketch}`;
        document.getElementById("terrain-name").innerText = `${current.terrain || 'Unknown'} Terrain`;
      }
    }

    loadData();
  </script>
</body>
</html>
