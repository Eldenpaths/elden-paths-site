
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Elden Paths — Master Map</title>
  <style>
    body {
      font-family: 'Georgia', serif;
      background-color: #f3efe2;
      color: #2d1b00;
      text-align: center;
      padding: 1rem;
    }
    #master-map {
      display: grid;
      gap: 1px;
      margin: 1rem auto;
      width: fit-content;
    }
    .tile {
      width: 20px;
      height: 20px;
      background-color: #d7ceb2;
      border: 1px solid #aaa;
      position: relative;
    }
    .tile.fogged {
      background-color: #999;
    }
    .tile img {
      width: 100%;
      height: 100%;
      opacity: 0.25;
      object-fit: cover;
    }
    .marker {
      position: absolute;
      font-size: 10px;
      bottom: 0;
      right: 0;
    }
    .legend {
      margin-top: 1rem;
    }
    .btn {
      margin: 4px;
      padding: 6px 12px;
      background: #e0d8c3;
      border: 1px solid #888;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>🗺️ Elden Paths — Master Map</h1>
  <div>
    <button class="btn" onclick="toggleFog()">Toggle Fog</button>
    <button class="btn" onclick="toggleLore()">Toggle Lore</button>
    <button class="btn" onclick="toggleStructures()">Toggle Structures</button>
    <button class="btn" onclick="location.href='play.html'">Return to Game</button>
  </div>

  
  <div id="calendar-bar" style="margin-top: 1rem; font-weight: bold;">
    🌗 <span id="calendarText">Loading in-world date...</span>
  </div>

  <div id="master-map"></div>
  <div class="legend">
    <p>⬛ Fogged | 🏰 Fort | 🏚 Ruin | ✨ Relic</p>
  </div>

  <script>
    let terrainMeta = {};
    let fogData = {};
    let loreData = {};
    let structuresData = {};
    let relicsData = {};
    let weatherData = {};
    let calendarData = {};
    let eventLog = {};
    let tileMeta = {};
    let fogEnabled = true;
    let loreEnabled = true;
    let structureEnabled = true;

    async function loadMap() {
      terrainMeta = (await fetch('meta.json').then(r => r.json())).tiles || {};
      try {
        fogData = (await fetch('fog.json').then(r => r.json()));
      } catch { fogData = {}; }
      try {
        loreData = await fetch('tile_lore.json').then(r => r.json());
      } catch { loreData = {}; }
      try {
        structuresData = await fetch('structures.json').then(r => r.json());
      } catch { structuresData = {}; }

      try { relicsData = await fetch("relics.json").then(r => r.json()); } catch { relicsData = {}; }
      try { weatherData = await fetch("weather.json").then(r => r.json()); } catch { weatherData = {}; }
      try { calendarData = await fetch("calendar.json").then(r => r.json()); } catch { calendarData = {}; }
try { eventLog = await fetch("event_log.json").then(r => r.json()); } catch { eventLog = {}; }
buildMasterMap()

      const calText = document.getElementById("calendarText");
      if (calendarData && calText) {
        calText.innerText = `Day ${calendarData.day} · Season: ${calendarData.season} · Moon: ${calendarData.moon} · Tide: ${calendarData.tide} · Event: ${calendarData.event}`;
      }
;
    }

    function buildMasterMap()

      const calText = document.getElementById("calendarText");
      if (calendarData && calText) {
        calText.innerText = `Day ${calendarData.day} · Season: ${calendarData.season} · Moon: ${calendarData.moon} · Tide: ${calendarData.tide} · Event: ${calendarData.event}`;
      }
 {
      const container = document.getElementById('master-map');
      container.innerHTML = '';
      container.style.gridTemplateColumns = `repeat(40, 1fr)`;

      for (let y = -20; y < 20; y++) {
        for (let x = -20; x < 20; x++) {
          const coord = `${x},${y}`;
          const tileData = terrainMeta[coord] || {};
          const tile = document.createElement('div');
          tile.className = 'tile';

          const discovered = Object.values(fogData).some(p => p.discovered?.includes(coord));

          if (fogEnabled && !discovered) tile.classList.add('fogged');

          if (tileData.sketch && (!fogEnabled || discovered)) {
            const img = document.createElement('img');
            img.src = `/assets/img/tiles/${tileData.sketch}`;
            tile.appendChild(img);
          }

          if (structureEnabled && structuresData[coord]) {
            const mark = document.createElement('div');
            mark.className = 'marker';
            mark.textContent = structuresData[coord].type === 'fort' ? '🏰' :
                               structuresData[coord].type === 'ruin' ? '🏚' : '🏠';
            tile.appendChild(mark);
          }

          if (loreEnabled && loreData[coord] && (!fogEnabled || discovered)) {
            tile.title = loreData[coord].title + ": " + loreData[coord].text;
          }

          
          if (relicsData[coord] && (!fogEnabled || discovered)) {
            const mark = document.createElement('div');
            mark.className = 'marker';
            mark.textContent = '✨';
            tile.appendChild(mark);
            tile.title = relicsData[coord].name + ' — ' + (relicsData[coord].lore || '');
            tile.style.border = '2px solid gold';
          }

          
          // Weather overlay icon
          if (weatherData[coord]) {
            const w = weatherData[coord];
            const wIcon = document.createElement('div');
            wIcon.style.position = 'absolute';
            wIcon.style.top = '0';
            wIcon.style.right = '0';
            wIcon.style.fontSize = '12px';
            wIcon.innerText =
              w.condition === 'sun' ? '☀️' :
              w.condition === 'rain' ? '🌧️' :
              w.condition === 'fog' ? '🌫️' :
              w.condition === 'storm' ? '⛈️' :
              w.condition === 'snow' ? '❄️' : '';
            wIcon.title = `${w.condition.charAt(0).toUpperCase() + w.condition.slice(1)} — ${w.intensity} — ${w.temp}°F`;
            div.appendChild(wIcon);
          }

          
          if (eventLog.events) {
            const eventsHere = eventLog.events.filter(e => e.tile === coord);
            if (eventsHere.length > 0) {
              const mark = document.createElement('div');
              mark.className = 'marker';
              mark.style.color = 'crimson';
              mark.innerText = '🌀';
              tile.appendChild(mark);
              const titles = eventsHere.map(e => e.title).join(", ");
              tile.title = (tile.title ? tile.title + "\n" : "") + "Events: " + titles;
            }
          }

          
          // Tide-aware tile filter
          if (tileMeta[coord]?.shoreline && calendarData?.tide) {
            const tideFilter = document.createElement('div');
            tideFilter.style.position = 'absolute';
            tideFilter.style.top = '0';
            tideFilter.style.left = '0';
            tideFilter.style.width = '100%';
            tideFilter.style.height = '100%';
            tideFilter.style.zIndex = '2';
            tideFilter.style.backgroundColor =
              calendarData.tide === 'high' ? 'rgba(0, 80, 180, 0.25)' :
              calendarData.tide === 'low' ? 'rgba(240, 230, 190, 0.2)' : 'transparent';
            tile.appendChild(tideFilter);
            tile.title = (tile.title ? tile.title + "\n" : "") + "Tide: " + calendarData.tide;
          }

          container.appendChild(tile);
        }
      }
    }

    function toggleFog() {
      fogEnabled = !fogEnabled;
      try { relicsData = await fetch("relics.json").then(r => r.json()); } catch { relicsData = {}; }
      try { weatherData = await fetch("weather.json").then(r => r.json()); } catch { weatherData = {}; }
      try { calendarData = await fetch("calendar.json").then(r => r.json()); } catch { calendarData = {}; }
try { eventLog = await fetch("event_log.json").then(r => r.json()); } catch { eventLog = {}; }
buildMasterMap()

      const calText = document.getElementById("calendarText");
      if (calendarData && calText) {
        calText.innerText = `Day ${calendarData.day} · Season: ${calendarData.season} · Moon: ${calendarData.moon} · Tide: ${calendarData.tide} · Event: ${calendarData.event}`;
      }
;
    }
    function toggleLore() {
      loreEnabled = !loreEnabled;
      try { relicsData = await fetch("relics.json").then(r => r.json()); } catch { relicsData = {}; }
      try { weatherData = await fetch("weather.json").then(r => r.json()); } catch { weatherData = {}; }
      try { calendarData = await fetch("calendar.json").then(r => r.json()); } catch { calendarData = {}; }
try { eventLog = await fetch("event_log.json").then(r => r.json()); } catch { eventLog = {}; }
buildMasterMap()

      const calText = document.getElementById("calendarText");
      if (calendarData && calText) {
        calText.innerText = `Day ${calendarData.day} · Season: ${calendarData.season} · Moon: ${calendarData.moon} · Tide: ${calendarData.tide} · Event: ${calendarData.event}`;
      }
;
    }
    function toggleStructures() {
      structureEnabled = !structureEnabled;
      try { relicsData = await fetch("relics.json").then(r => r.json()); } catch { relicsData = {}; }
      try { weatherData = await fetch("weather.json").then(r => r.json()); } catch { weatherData = {}; }
      try { calendarData = await fetch("calendar.json").then(r => r.json()); } catch { calendarData = {}; }
try { eventLog = await fetch("event_log.json").then(r => r.json()); } catch { eventLog = {}; }
buildMasterMap()

      const calText = document.getElementById("calendarText");
      if (calendarData && calText) {
        calText.innerText = `Day ${calendarData.day} · Season: ${calendarData.season} · Moon: ${calendarData.moon} · Tide: ${calendarData.tide} · Event: ${calendarData.event}`;
      }
;
    }

    loadMap();
  </script>
</body>
</html>
