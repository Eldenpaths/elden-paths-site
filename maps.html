<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Elden Paths‚Ñ¢ Admin Map</title>
  <style>
    canvas {
      border: 1px solid black;
      display: block;
      margin: 20px auto;
    }
    .lore-popup, .hover-popup, #adminPanel {
      position: absolute;
      background: #fff;
      font-family: serif;
      z-index: 10;
    }
    .lore-popup {
      padding: 10px;
      border: 1px solid #333;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      max-width: 300px;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
    }
    .hover-popup {
      pointer-events: none;
      font-size: 12px;
      padding: 5px;
      border: 1px solid #999;
    }
    #adminPanel {
      display: none;
      top: 10px;
      right: 10px;
      background: #f4f4f4;
      border: 2px solid #444;
      padding: 10px;
      width: 200px;
    }
    #adminPanel button {
      display: block;
      margin: 6px 0;
      width: 100%;
    }
  </style>
</head>
<body>

<h1 style="text-align:center; color:#fce5c0; font-family:Georgia, serif;">Elden Paths‚Ñ¢ ‚Äì Dev Map</h1>
<canvas id="mapCanvas" width="800" height="800"></canvas>

<div id="adminPanel">
  <strong>Admin Tools</strong><br><br>
  <button onclick="adminMode='fog'">üß≠ Toggle Fog</button>
  <button onclick="adminMode='marker'">üìç Add Marker</button>
  <button onclick="adminMode='structure'">üèï Add Structure</button>
  <button onclick="adminMode='move'">üö∂ Move Player</button>
  <button onclick="adminMode='lore'">üßæ Edit Lore</button>
  <button onclick="drawMap()">üîÅ Redraw</button>
  <button onclick="toggleAdmin()">‚ùå Close</button>
</div>

<script>
const canvas = document.getElementById('mapCanvas');
const ctx = canvas.getContext('2d');
const tileSize = 40;

let tile_index = {}, tile_meta = {}, trails = [], markers = {}, player = { x: 0, y: 0 };
let structures = {}, tile_events = {};
let adminMode = null;

async function loadJSON(path) {
  const res = await fetch(path);
  return res.json();
}

async function loadData() {
  [tile_index, tile_meta, trails, markers, playerData, structures, tile_events] = await Promise.all([
    loadJSON('data/tile_index.json'),
    loadJSON('data/tile_meta.json'),
    loadJSON('data/trails.json'),
    loadJSON('data/tile_markers.json'),
    loadJSON('data/players.json'),
    loadJSON('data/structures.json'),
    loadJSON('data/tile_events.json')
  ]);
  player = Object.values(playerData)[0] || { x: 0, y: 0 };
  drawMap();
}

function drawMap() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const cols = canvas.width / tileSize;
  const rows = canvas.height / tileSize;

  for (let y = 0; y < rows; y++) {
    for (let x = 0; x < cols; x++) {
      const key = `${x},${y}`;
      const known = tile_index[key]?.fog === false;
      const terrain = tile_meta[key]?.terrain || 'unknown';

      if (player.x === x && player.y === y && tile_index[key]) {
        tile_index[key].fog = false;
      }

      ctx.fillStyle = known ? terrainColor(terrain) : '#000';
      ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);

      if (known && markers[key]) drawMarkerIcon(x, y, markers[key].type);
      if (player.x === x && player.y === y) {
        ctx.strokeStyle = '#ff0';
        ctx.lineWidth = 2;
        ctx.strokeRect(x * tileSize, y * tileSize, tileSize, tileSize);
      }
    }
  }

  drawTrails();
  drawStructures();
}

function terrainColor(type) {
  return {
    forest: '#228B22',
    mountain: '#888',
    water: '#1E90FF',
    plains: '#DAA520'
  }[type] || '#444';
}

function drawMarkerIcon(x, y, type) {
  ctx.fillStyle = {
    city: '#2E8B57',
    relic: '#8B0000',
    quest: '#4169E1'
  }[type] || '#ccc';
  ctx.beginPath();
  ctx.arc(x * tileSize + tileSize/2, y * tileSize + tileSize/2, 6, 0, 2 * Math.PI);
  ctx.fill();
}

function drawStructures() {
  for (const key in structures) {
    const [x, y] = key.split(',').map(Number);
    const type = structures[key].type;
    ctx.fillStyle = { watchtower: '#8888cc', farm: '#cc8844' }[type] || '#ccc';
    ctx.fillRect(x * tileSize + tileSize/4, y * tileSize + tileSize/4, tileSize/2, tileSize/2);
  }
}

canvas.addEventListener('click', (e) => {
  const rect = canvas.getBoundingClientRect();
  const x = Math.floor((e.clientX - rect.left) / tileSize);
  const y = Math.floor((e.clientY - rect.top) / tileSize);
  const key = `${x},${y}`;
  const tile = tile_index[key];

  if (adminMode) {
    if (adminMode === 'fog') {
      if (!tile_index[key]) tile_index[key] = {};
      tile_index[key].fog = !tile_index[key].fog;
    }
    if (adminMode === 'marker') {
      markers[key] = { type: prompt("Marker type? (city, quest, relic)") || "city" };
    }
    if (adminMode === 'structure') {
      structures[key] = { type: prompt("Structure type? (farm, watchtower)") || "farm" };
    }
    if (adminMode === 'move') {
      player.x = x; player.y = y;
    }
    if (adminMode === 'lore') {
      if (!tile_index[key]) tile_index[key] = {};
      tile_index[key].lore = prompt("Lore text:", tile_index[key].lore || "") || tile_index[key].lore;
    }
    drawMap();
    return;
  }

  if (tile && tile.fog === false && tile.lore) {
    showLorePopup(tile.lore);
  }

  const evt = tile_events[key];
  if (evt) {
    alert(evt.type === "sketch" ? `üñºÔ∏è Scene: ${evt.scene}` :
          evt.type === "battle" ? `‚öîÔ∏è Battle with: ${evt.enemy}` :
          `üìú ${evt.text}`);
  }
});

function showLorePopup(text) {
  const popup = document.createElement('div');
  popup.className = 'lore-popup';
  popup.innerHTML = `<p>${text}</p>`;
  document.body.appendChild(popup);
  setTimeout(() => popup.remove(), 6000);
}

let hoverPopup = null;
canvas.addEventListener('mousemove', (e) => {
  const rect = canvas.getBoundingClientRect();
  const x = Math.floor((e.clientX - rect.left) / tileSize);
  const y = Math.floor((e.clientY - rect.top) / tileSize);
  const key = `${x},${y}`;
  const tile = tile_index[key];
  const terrain = tile_meta[key]?.terrain;
  const lore = tile?.lore;

  if (hoverPopup) hoverPopup.remove();
  hoverPopup = document.createElement('div');
  hoverPopup.className = 'hover-popup';
  hoverPopup.style.left = `${e.clientX + 10}px`;
  hoverPopup.style.top = `${e.clientY + 10}px`;
  hoverPopup.innerHTML = `<b>(${x},${y})</b><br>${terrain ? `Terrain: ${terrain}<br>` : ''}${tile?.fog === false && lore ? `üßæ ${lore}` : ''}`;
  document.body.appendChild(hoverPopup);
});
canvas.addEventListener('mouseleave', () => { if (hoverPopup) hoverPopup.remove(); });

document.addEventListener('keydown', (e) => {
  if (e.key === '`' || e.key === '~') toggleAdmin();
  let dx = 0, dy = 0;
  if (e.key === 'ArrowUp') dy = -1;
  if (e.key === 'ArrowDown') dy = 1;
  if (e.key === 'ArrowLeft') dx = -1;
  if (e.key === 'ArrowRight') dx = 1;
  if (e.key === 'm') drawMap();

  const newX = player.x + dx, newY = player.y + dy, key = `${newX},${newY}`;
  if (tile_index[key] && tile_index[key].fog === false) {
    player.x = newX; player.y = newY;
    drawMap();
  }
});

function toggleAdmin() {
  const panel = document.getElementById("adminPanel");
  panel.style.display = panel.style.display === "block" ? "none" : "block";
  adminMode = null;
}

loadData();
</script>
</body>
</html>