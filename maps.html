<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elden Paths â€“ World Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html, body, #map { margin: 0; height: 100%; width: 100%; background: #000; }
    .marker-shrine { background-color: gold; border-radius: 50%; width: 12px; height: 12px; border: 1px solid #444; }
    .marker-player { background-color: cyan; border: 2px solid #fff; border-radius: 50%; width: 14px; height: 14px; }
    .marker-echo { background-color: purple; border: 2px solid #fff; border-radius: 50%; width: 14px; height: 14px; }
    .marker-encounter { background-color: red; border-radius: 50%; width: 10px; height: 10px; box-shadow: 0 0 5px 2px rgba(255, 0, 0, 0.6); }
    .popup-sketch { max-width: 300px; max-height: 300px; display: block; }
  </style>
</head>
<body>
<div id="map"></div>
<script>
  const map = L.map('map', {
    minZoom: 1,
    maxZoom: 3,
    crs: L.CRS.Simple
  }).setView([0, 0], 1);

  const bounds = [[0,0], [1024*3, 1024*3]];
  const tileLayer = L.tileLayer('./map_tiles/z1/{x}_{y}.png', {
    tileSize: 1024,
    noWrap: true,
    bounds: bounds,
    errorTileUrl: ''
  }).addTo(map);

  // Load fog overlay
  fetch("./data/tile_index.json")
    .then(res => res.json())
    .then(tileIndex => {
      for (const key in tileIndex) {
        const [x, y] = key.split("_").map(Number);
        const tile = tileIndex[key];
        if (!tile.fog_cleared) {
          const x1 = x * 1024, y1 = y * 1024;
          const x2 = x1 + 1024, y2 = y1 + 1024;
          L.rectangle([[y1, x1], [y2, x2]], {
            color: "#000",
            fillColor: "#000",
            fillOpacity: 0.65,
            weight: 0
          }).addTo(map);
        }
      }
    });

  // Load marker types and sketch previews
  fetch("./data/tile_markers.json")
    .then(res => res.json())
    .then(data => {
      for (const tile in data) {
        const [x, y] = tile.split("_").map(Number);
        const px = x * 1024 + 512;
        const py = y * 1024 + 512;

        for (const marker of data[tile]) {
          if (marker.type === "shrine") {
            const icon = L.divIcon({ className: 'marker-shrine' });
            L.marker([py, px], { icon }).addTo(map).bindPopup(marker.name || "Shrine");
          }

          if (marker.type === "encounter" && marker.active) {
            const icon = L.divIcon({ className: 'marker-encounter' });
            const label = `Encounter: ${marker.encounter_type || "Unknown Event"}`;
            L.marker([py, px], { icon }).addTo(map).bindPopup(label);
          }

          if (marker.sketch_trigger) {
            const imgSrc = `./sketches/${tile}.png`;
            const preview = `<img src="${imgSrc}" class="popup-sketch" alt="Sketch for ${tile}" />`;
            const thumb = L.rectangle([[py-100, px-100], [py+100, px+100]], {
              color: "#fff",
              weight: 1,
              fillOpacity: 0.05
            }).addTo(map);
            thumb.bindPopup(preview);
          }
        }
      }
    });

  // Load players
  fetch("./data/players.json")
    .then(res => res.json())
    .then(players => {
      for (const name in players) {
        const player = players[name];
        const [x, y] = player.tile.split("_").map(Number);
        const px = x * 1024 + 512;
        const py = y * 1024 + 512;
        const iconClass = player.is_echo ? 'marker-echo' : 'marker-player';
        const icon = L.divIcon({ className: iconClass });
        const label = `${name} (HP: ${player.hp}, XP: ${player.xp})`;
        L.marker([py, px], { icon }).addTo(map).bindPopup(label);
      }
    });
</script>
</body>
</html>
