<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Elden Paths ‚Äì Player Map</title>
  <style>
    body {
      font-family: 'Georgia', serif;
      background: #f5f2e7;
      color: #2d1b00;
      text-align: center;
      padding: 1rem;
    }
    #map {
      display: grid;
      gap: 2px;
      margin: 1rem auto;
      width: fit-content;
    }
    .tile {
      width: 48px;
      height: 48px;
      background: #ddd4bb;
      border: 1px solid #bbb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .fogged {
      background: #999 !important;
    }
    .player {
      background: #334 !important;
      color: #fff;
      font-weight: bold;
    }
    #terrain-box {
      margin-top: 2rem;
    }
    #terrain-img {
      width: 200px;
      border: 2px solid #ccc;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <h2>üó∫Ô∏è Elden Paths ‚Äî Player Map</h2>
  <p id="infoText">Loading...</p>

  <div id="map"></div>

  <div id="terrain-box">
    <h3 id="terrain-name">Terrain Preview</h3>
    <img id="terrain-img" src="" alt="Tile sketch" />
  </div>

  <script>
    let playerName = "test_player"; // default or hardcoded for now
    let zoomLevel = 5; // Default grid size (5x5)
    const mapElement = document.getElementById("map");
    const infoText = document.getElementById("infoText");

    let terrainMeta = {};
    let playerData = {};
    let fogData = {};

    async function loadData() {
      terrainMeta = (await fetch('meta.json').then(r => r.json())).tiles || {};
      playerData = (await fetch('players.json').then(r => r.json()))[playerName];
      fogData = (await fetch('fog.json').then(r => r.json()))[playerName]?.discovered || [];

      buildMap();
    }

    function buildMap() {
      const [px, py] = playerData.tile.split(',').map(Number);
      const size = zoomLevel;
      const half = Math.floor(size / 2);
      mapElement.innerHTML = '';
      mapElement.style.gridTemplateColumns = `repeat(${size}, 1fr)`;

      for (let y = py - half; y <= py + half; y++) {
        for (let x = px - half; x <= px + half; x++) {
          const coord = `${x},${y}`;
          const tileData = terrainMeta[coord] || {};
          const isDiscovered = fogData.includes(coord);
          const div = document.createElement('div');
          div.className = 'tile';
          if (!isDiscovered) div.classList.add('fogged');
          if (coord === playerData.tile) div.classList.add('player');
          div.innerText = tileData.terrain ? tileData.terrain[0].toUpperCase() : '?';
          mapElement.appendChild(div);
        }
      }

      const current = terrainMeta[playerData.tile] || {};
      infoText.innerText = `Tile: ${playerData.tile} | Region: ${current.region || 'Unknown'} | Terrain: ${current.terrain || '??'} | Elevation: ${current.elevation || '-'}`;

      const sketch = current.sketch;
      if (sketch) {
        document.getElementById("terrain-img").src = `/assets/img/tiles/${sketch}`;
        document.getElementById("terrain-name").innerText = `${current.terrain || 'Unknown'} Terrain`;
      }
    }

    // Hotkey logic
    window.addEventListener('keydown', (e) => {
      if (e.key === '1') { zoomLevel = 1; buildMap(); }
      if (e.key === '5') { zoomLevel = 5; buildMap(); }
      if (e.key === '0') { zoomLevel = 10; buildMap(); }
      if (e.key === 'a') { zoomLevel = 20; buildMap(); }
    });

    loadData();
  </script>
</body>
</html>
